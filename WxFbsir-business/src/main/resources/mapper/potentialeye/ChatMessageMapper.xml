<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wx.fbsir.business.potentialeye.mapper.ChatMessageMapper">
    
    <resultMap type="ChatMessage" id="ChatMessageResult">
        <result property="chatId"    column="chat_id"    />
        <result property="messageId"    column="message_id"    />
        <result property="sessionId"    column="session_id"    />
        <result property="content"    column="content"    />
        <result property="role"    column="role"    />
        <result property="isRead"    column="is_read"    />
        <result property="pointCost"    column="point_cost"    />
        <result property="createdTime"    column="created_time"    />
        <result property="updateTime"    column="update_time"    />
    </resultMap>

    <sql id="selectChatMessageVo">
        select chat_id, message_id, session_id, content, role, is_read, point_cost, created_time, update_time from chat_message
    </sql>

    <select id="selectChatMessageList" parameterType="ChatMessage" resultMap="ChatMessageResult">
        <include refid="selectChatMessageVo"/>
        <where>  
            <if test="messageId != null  and messageId != ''"> and message_id = #{messageId}</if>
            <if test="sessionId != null  and sessionId != ''"> and session_id = #{sessionId}</if>
            <if test="content != null  and content != ''"> and content = #{content}</if>
            <if test="role != null  and role != ''"> and role = #{role}</if>
            <if test="isRead != null "> and is_read = #{isRead}</if>
            <if test="pointCost != null "> and point_cost = #{pointCost}</if>
            <if test="createdTime != null "> and created_time = #{createdTime}</if>
        </where>
    </select>
    
    <select id="selectChatMessageByChatId" parameterType="Long" resultMap="ChatMessageResult">
        <include refid="selectChatMessageVo"/>
        where chat_id = #{chatId}
    </select>

    <select id="selectUnreadMessages" resultMap="ChatMessageResult">
        select * from chat_message
        where session_id = #{sessionId} and is_read = 0 and role = 'AI'
        order by created_time asc
    </select>
    <select id="selectChatMessageByMessageId"
            resultType="com.wx.fbsir.business.potentialeye.domain.ChatMessage">
        select * from chat_message where message_id = #{messageId} limit 1
    </select>

    <insert id="insertChatMessage" parameterType="ChatMessage">
        insert into chat_message
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="chatId != null">chat_id,</if>
            <if test="messageId != null">message_id,</if>
            <if test="sessionId != null">session_id,</if>
            <if test="content != null">content,</if>
            <if test="role != null">role,</if>
            <if test="isRead != null">is_read,</if>
            <if test="pointCost != null">point_cost,</if>
            <if test="createdTime != null">created_time,</if>
            <if test="updateTime != null">update_time,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="chatId != null">#{chatId},</if>
            <if test="messageId != null">#{messageId},</if>
            <if test="sessionId != null">#{sessionId},</if>
            <if test="content != null">#{content},</if>
            <if test="role != null">#{role},</if>
            <if test="isRead != null">#{isRead},</if>
            <if test="pointCost != null">#{pointCost},</if>
            <if test="createdTime != null">#{createdTime},</if>
            <if test="updateTime != null">#{updateTime},</if>
         </trim>
    </insert>

    <update id="updateChatMessage" parameterType="ChatMessage">
        update chat_message
        <trim prefix="SET" suffixOverrides=",">
            <if test="messageId != null">message_id = #{messageId},</if>
            <if test="sessionId != null">session_id = #{sessionId},</if>
            <if test="content != null">content = #{content},</if>
            <if test="role != null">role = #{role},</if>
            <if test="isRead != null">is_read = #{isRead},</if>
            <if test="pointCost != null">point_cost = #{pointCost},</if>
            <if test="createdTime != null">created_time = #{createdTime},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </trim>
        where chat_id = #{chatId}
    </update>
    <update id="markAsRead">
        update chat_message
        set is_read = 1, update_time = now()
        where session_id = #{sessionId}
        <if test="ids != null and ids.size() > 0">
            and chat_id in
            <foreach item="id" collection="ids" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
    </update>

    <delete id="deleteChatMessageByChatId" parameterType="Long">
        delete from chat_message where chat_id = #{chatId}
    </delete>

    <delete id="deleteChatMessageByChatIds" parameterType="String">
        delete from chat_message where chat_id in 
        <foreach item="chatId" collection="array" open="(" separator="," close=")">
            #{chatId}
        </foreach>
    </delete>
</mapper>