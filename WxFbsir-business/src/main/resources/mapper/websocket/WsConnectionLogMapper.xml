<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wx.fbsir.business.websocket.mapper.WsConnectionLogMapper">

    <resultMap type="com.wx.fbsir.business.websocket.domain.WsConnectionLog" id="WsConnectionLogResult">
        <result property="id" column="id"/>
        <result property="sessionId" column="session_id"/>
        <result property="hostId" column="host_id"/>
        <result property="deviceId" column="device_id"/>
        <result property="engineVersion" column="engine_version"/>
        <result property="remoteIp" column="remote_ip"/>
        <result property="remotePort" column="remote_port"/>
        <result property="requestUri" column="request_uri"/>
        <result property="osName" column="os_name"/>
        <result property="osVersion" column="os_version"/>
        <result property="javaVersion" column="java_version"/>
        <result property="hostname" column="hostname"/>
        <result property="macAddress" column="mac_address"/>
        <result property="connectTime" column="connect_time"/>
        <result property="registerTime" column="register_time"/>
        <result property="disconnectTime" column="disconnect_time"/>
        <result property="durationSeconds" column="duration_seconds"/>
        <result property="status" column="status"/>
        <result property="rejectReason" column="reject_reason"/>
        <result property="closeCode" column="close_code"/>
        <result property="closeReason" column="close_reason"/>
        <result property="messageSent" column="message_sent"/>
        <result property="messageReceived" column="message_received"/>
        <result property="heartbeatCount" column="heartbeat_count"/>
        <result property="errorCount" column="error_count"/>
        <result property="lastError" column="last_error"/>
        <result property="delFlag" column="del_flag"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="selectConnectionLogVo">
        SELECT id, session_id, host_id, device_id, engine_version, remote_ip, remote_port,
               request_uri, os_name, os_version, java_version, hostname, mac_address,
               connect_time, register_time, disconnect_time, duration_seconds,
               status, reject_reason, close_code, close_reason,
               message_sent, message_received, heartbeat_count, error_count, last_error,
               del_flag, create_time, update_time
        FROM ws_connection_log
    </sql>

    <select id="selectBySessionId" parameterType="String" resultMap="WsConnectionLogResult">
        <include refid="selectConnectionLogVo"/>
        WHERE session_id = #{sessionId} AND del_flag = 0
    </select>

    <select id="selectList" parameterType="com.wx.fbsir.business.websocket.domain.WsConnectionLog" resultMap="WsConnectionLogResult">
        <include refid="selectConnectionLogVo"/>
        <where>
            del_flag = 0
            <if test="sessionId != null and sessionId != ''">
                AND session_id = #{sessionId}
            </if>
            <if test="hostId != null and hostId != ''">
                AND host_id LIKE CONCAT('%', #{hostId}, '%')
            </if>
            <if test="deviceId != null and deviceId != ''">
                AND device_id = #{deviceId}
            </if>
            <if test="remoteIp != null and remoteIp != ''">
                AND remote_ip LIKE CONCAT('%', #{remoteIp}, '%')
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        ORDER BY connect_time DESC
    </select>

    <insert id="insert" parameterType="com.wx.fbsir.business.websocket.domain.WsConnectionLog" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO ws_connection_log (
            session_id, remote_ip, remote_port, request_uri, connect_time, status
        ) VALUES (
            #{sessionId}, #{remoteIp}, #{remotePort}, #{requestUri}, NOW(), #{status}
        )
    </insert>

    <update id="update" parameterType="com.wx.fbsir.business.websocket.domain.WsConnectionLog">
        UPDATE ws_connection_log
        <set>
            <if test="hostId != null">host_id = #{hostId},</if>
            <if test="deviceId != null">device_id = #{deviceId},</if>
            <if test="engineVersion != null">engine_version = #{engineVersion},</if>
            <if test="osName != null">os_name = #{osName},</if>
            <if test="osVersion != null">os_version = #{osVersion},</if>
            <if test="javaVersion != null">java_version = #{javaVersion},</if>
            <if test="hostname != null">hostname = #{hostname},</if>
            <if test="macAddress != null">mac_address = #{macAddress},</if>
            <if test="status != null">status = #{status},</if>
            <if test="closeCode != null">close_code = #{closeCode},</if>
            <if test="closeReason != null">close_reason = #{closeReason},</if>
            <if test="rejectReason != null">reject_reason = #{rejectReason},</if>
            <if test="delFlag != null">del_flag = #{delFlag},</if>
            update_time = NOW()
        </set>
        WHERE session_id = #{sessionId}
    </update>

    <update id="updateRegistered">
        UPDATE ws_connection_log SET
            host_id = #{hostId},
            device_id = #{deviceId},
            engine_version = #{engineVersion},
            hostname = #{hostname},
            os_name = #{osName},
            os_version = #{osVersion},
            java_version = #{javaVersion},
            mac_address = #{macAddress},
            register_time = NOW(),
            status = #{status},
            update_time = NOW()
        WHERE session_id = #{sessionId}
    </update>

    <update id="updateDisconnected">
        UPDATE ws_connection_log SET
            status = #{status},
            close_code = #{closeCode},
            close_reason = #{closeReason},
            disconnect_time = NOW(),
            duration_seconds = TIMESTAMPDIFF(SECOND, connect_time, NOW()),
            message_sent = #{messageSent},
            message_received = #{messageReceived},
            heartbeat_count = #{heartbeatCount},
            error_count = #{errorCount},
            last_error = #{lastError},
            update_time = NOW()
        WHERE session_id = #{sessionId}
    </update>

    <update id="updateConnectionIp">
        UPDATE ws_connection_log SET
            remote_ip = #{publicIp},
            update_time = NOW()
        WHERE session_id = #{sessionId}
    </update>

    <update id="updateRejected">
        UPDATE ws_connection_log SET
            host_id = #{hostId},
            status = #{status},
            reject_reason = #{rejectReason},
            error_code = #{errorCode},
            last_error = CONCAT('连接被拒绝 - 错误码: ', COALESCE(#{errorCode}, '无'), ', 原因: ', COALESCE(#{rejectReason}, '未知')),
            disconnect_time = NOW(),
            update_time = NOW()
        WHERE session_id = #{sessionId}
    </update>

    <select id="selectConnectionStats" resultType="java.util.Map">
        SELECT 
            DATE(connect_time) AS stat_date,
            COUNT(*) AS total_connections,
            SUM(CASE WHEN status IN (1, 2) THEN 1 ELSE 0 END) AS success_connections,
            SUM(CASE WHEN status IN (4, 5, 6) THEN 1 ELSE 0 END) AS rejected_connections,
            SUM(CASE WHEN status = 3 THEN 1 ELSE 0 END) AS abnormal_disconnections,
            COUNT(DISTINCT remote_ip) AS unique_ips,
            COUNT(DISTINCT host_id) AS unique_hosts
        FROM ws_connection_log
        WHERE del_flag = 0
        <if test="startDate != null and startDate != ''">
            AND DATE(connect_time) >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND DATE(connect_time) &lt;= #{endDate}
        </if>
        GROUP BY DATE(connect_time)
        ORDER BY stat_date DESC
    </select>

    <select id="selectByHostId" resultMap="WsConnectionLogResult">
        <include refid="selectConnectionLogVo"/>
        WHERE host_id = #{hostId} AND del_flag = 0
        ORDER BY connect_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

</mapper>
