# ========================================
# WxFbsir Engine 副节点配置
# 独立部署，通过 WebSocket 与主节点通信
# ========================================
# 【安全策略】本项目禁止从环境变量读取配置参数
# 所有配置必须在此文件中明确指定，不支持 ${ENV_VAR} 语法
# ========================================

server:
  port: 8081
  servlet:
    context-path: /

spring:
  application:
    name: wxfbsir-engine

# ========================================
# Engine 节点配置
# ========================================
wxfbsir:
  engine:
    # ========================================
    # 【重要】主机ID配置 - 必须向管理员申请获取
    # ========================================
    # 主机ID是连接主节点的唯一凭证，需要：
    # 1. 联系管理员申请主机ID
    # 2. 管理员在主节点数据库白名单表中添加此ID
    # 3. 将申请到的主机ID填写到此处
    # 注意：一个主机ID只允许一个Engine连接，请勿共享
    # 使用数据库中存在的白名单ID：engine-dev-001（开发测试）或 engine-prod-001（生产环境）
    host-id: engine-001
    
    # 节点版本（用于版本追踪和兼容性检查）
    # 版本号从 pom.xml 的 engine.version 属性自动注入
    version: @engine.version@
    
    # 主节点 WebSocket 连接配置
    admin:
      # 主节点 WebSocket 地址
      ws-url: ws://localhost:8080/ws/engine
      
    # 连接配置
    connection:
      # 连接超时时间（毫秒）
      timeout: 10000
      # 心跳间隔（秒）
      heartbeat-interval: 30
      # 心跳超时时间（秒）
      heartbeat-timeout: 10
      
    # 重连策略（固定间隔）
    reconnect:
      # 是否启用自动重连
      enabled: true
      # 最大重试次数（10次 * 30秒 = 300秒超时）
      max-retries: 10
      # 初始重连延迟（秒）
      initial-delay: 30
      # 最大重连延迟（秒）
      max-delay: 30
      # 退避乘数（1.0 表示固定间隔）
      backoff-multiplier: 1.0
      
    # ========================================
    # Playwright 浏览器自动化配置
    # ========================================
    playwright:
      # 是否启用 Playwright 功能
      enabled: true
      # 是否启用动态性能适配（根据系统CPU/内存自动调整配置）
      # 启用后，设置为0的配置项将根据系统性能自动计算
      dynamic-performance: true
      # 浏览器用户数据目录（用于保存登录状态等）
      # 每个用户的数据隔离存储在：{data-dir}/{会话名称}/{用户ID}/
      # 相对路径：相对于运行时工作目录（java -jar 所在目录）
      data-dir: ./data/playwright
      # 默认是否使用无头模式（false=显示浏览器窗口，true=后台运行）
      headless: false
      
      # 浏览器池配置
      pool:
        # 最大并发浏览器实例数
        # 设置为 0 时启用动态计算（根据 CPU 核心数和内存自动设置）
        # 手动设置时建议值：CPU核心数 * 2，但不超过可用内存/300MB
        max-size: 0
        # 最小空闲实例数（预热）
        min-idle: 0
        # 会话超时时间（毫秒，默认1小时）
        # 超时的空闲会话会被自动清理
        session-timeout: 3600000
        # 过期会话清理检查间隔（毫秒，默认5分钟）
        cleanup-interval: 300000
        # 获取会话等待超时（毫秒，默认30秒）
        # 当所有浏览器实例都在使用时，等待可用实例的最大时间
        acquire-timeout: 30000
        
      # 浏览器启动配置
      browser:
        # 浏览器启动超时（毫秒，默认60秒）
        launch-timeout: 60000
        # 页面导航超时（毫秒，默认30秒）
        navigation-timeout: 30000
        # 视口宽度（像素）
        viewport-width: 1280
        # 视口高度（像素）
        viewport-height: 720
        # 是否禁用图片加载（减少资源消耗，低性能系统自动启用）
        disable-images: false
        # 是否禁用 GPU 加速（建议保持 true 以提高稳定性）
        disable-gpu: true
        # 启动失败最大重试次数
        max-retries: 3
        # 重试间隔基础时间（毫秒，实际等待=重试次数*此值）
        retry-interval: 2000
        
      # 线程池配置（用于异步任务执行）
      thread-pool:
        # 核心线程数（设置为 0 时根据 CPU 核心数自动计算）
        core-size: 0
        # 最大线程数（设置为 0 时根据 CPU 核心数自动计算）
        max-size: 0
        # 线程空闲时间（秒）
        keep-alive-seconds: 60
        # 任务队列大小（设置为 0 时根据浏览器池大小自动计算）
        queue-capacity: 0

# ========================================
# 日志配置
# ========================================
logging:
  level:
    root: INFO
    com.wx.fbsir.engine: DEBUG
    org.springframework: WARN
    org.java_websocket: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%logger{36}] - %msg%n"
  file:
    name: logs/engine.log
  logback:
    rollingpolicy:
      max-file-size: 50MB
      max-history: 30

# ========================================
# Actuator 健康检查配置
# ========================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: always
  health:
    defaults:
      enabled: true
