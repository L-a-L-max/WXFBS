# 元器（YuanQi）使用指南

## 📚 目录

### � 新手快速上手
- [快速开始](#quick-start) - 3分钟上手指南
- [基础测试](#basic-test) - 简单JSON测试

### 💻 开发者详细文档  
- [登录功能详解](#login-details) - 登录检测与扫码登录
- [工作流导航详解](#workflow-details) - 工作流操作流程
- [代码架构说明](#code-structure) - 技术实现细节
- [故障排除指南](#troubleshooting) - 问题解决方案

---

## <span id="quick-start">� 快速开始 - 3分钟上手</span>

### 第1步：打开调试页面
访问前端调试页面：`主机管理 - WebSocket调试`

### 第2步：测试登录检测
复制粘贴以下JSON到调试页面：
```json
{"type": "YUANQI_CHECK_LOGIN", "engineId": "engine-001"}
```
点击发送，查看返回的 `isLoggedIn` 字段。

### 第3步：扫码登录（如果未登录）
```json
{"type": "YUANQI_SCAN_LOGIN", "engineId": "engine-001"}
```
扫描返回的二维码完成登录。

### 第4步：测试工作流导航
```json
{
  "type": "YUANQI_NAVIGATE_WORKFLOW",
  "engineId": "engine-001",
  "payload": {
    "spaceName": "个人空间",
    "agentName": "你的智能体名称",
    "workflowName": "你的工作流名称"
  }
}
```

🎉 **完成！** 你已经学会了基本操作。

---

## <span id="basic-test">🧪 基础测试</span>

### 快速测试清单

| 测试项目 | JSON模板 | 预期结果 |
|---------|----------|----------|
| ✅ **登录检测** | `{"type": "YUANQI_CHECK_LOGIN", "engineId": "engine-001"}` | 返回登录状态 |
| 📱 **扫码登录** | `{"type": "YUANQI_SCAN_LOGIN", "engineId": "engine-001"}` | 显示二维码 |
| 🔍 **页面测试** | `{"type": "YUANQI_TEST_VIEW", "engineId": "engine-001"}` | 截图5张 |
| 🔄 **工作流导航** | 见上方JSON | 打开编辑页面 |

### 常见返回格式
```json
{
  "success": true,
  "data": {
    "isLoggedIn": true,
    "userName": "用户名",
    "screenshotUrl": "截图链接"
  }
}
```

---

## <span id="login-details">🔐 登录功能详解</span>

### 登录状态检测原理

**检测机制：** 通过DOM元素判断登录状态
- 未登录：左侧菜单存在"登录"按钮
- 已登录：无登录按钮，尝试提取用户信息

**技术实现：**
```java
// 关键代码片段
Locator loginButton = page.locator("aside.yuanqi-sidebar button:has-text('登录')");
if (loginButton.count() > 0 && loginButton.isVisible()) {
    return "false"; // 未登录
}
```

**API规格：**
```json
// 请求格式
{
  "type": "YUANQI_CHECK_LOGIN",
  "engineId": "engine-001"
}
```

// 返回格式
{
  "success": true,
  "data": {
    "isLoggedIn": true,
    "userName": "用户昵称", // 已登录时返回
    "platform": "YuanQi",
    "timestamp": 1736144400000
  }
}
```

### 扫码登录流程详解

**核心流程：** 实时监控登录状态 + 二维码自动更新

```
触发扫码 → 生成二维码 → 用户扫码 → 检测成功 → 数据持久化
    ↓           ↓           ↓         ↓           ↓
  点击登录    立即截图推送   微信确认   页面跳转    等待3秒
```

**关键技术点：**
1. **二维码更新机制：** 每30秒自动刷新防过期
2. **登录检测：** 每2秒轮询检查页面状态
3. **数据持久化：** 登录成功后等待Chromium写入Cookie
4. **超时处理：** 5分钟总超时保护

**实现细节：**
```java
// 监听页面变化判断登录成功
boolean stillOnLoginPage = loginUtil.isStillOnLoginPage(page);
if (!stillOnLoginPage) {
    // 页面跳转 = 登录成功
    Thread.sleep(3000); // 等待数据持久化
    return success;
}
```

**API规格：**
```json
// 请求
{"type": "YUANQI_SCAN_LOGIN", "engineId": "engine-001"}

// 流式返回
{
  "success": true,
  "data": {
    "userName": "登录用户名",
    "qrCodeUrl": "二维码图片URL",
    "loginTime": 45, // 登录耗时秒数
    "alreadyLoggedIn": false
  }
}
```

---

## <span id="workflow-details">🔄 工作流导航详解</span>

### 导航流程架构

**7步导航流程：**
```
个人空间 → 选择空间 → 展开智能体 → 选择智能体 → 工作流管理 → 找到工作流 → 点击编辑
```

**技术实现策略：**
- **文本精确匹配：** 使用 `page.getByText()` 精确定位
- **智能等待：** 每步操作后动态等待页面加载
- **容错处理：** 支持"我的智能体"和"团队智能体"两种场景
- **新窗口监听：** 自动捕获编辑页面打开事件

### 关键技术实现

**核心工具方法：**
```java
public boolean clickByText(Page page, String text, String description, int waitMillis) {
    Locator element = page.getByText(text, new Page.GetByTextOptions().setExact(true));
    element.first().waitFor(); // 智能等待
    element.first().click();
    if (waitMillis > 0) page.waitForTimeout(waitMillis);
    return true;
}
```

**新窗口处理：**
```java
// 监听新页面打开
Page newPage = page.context().waitForPage(() -> {
    editButton.click(); // 触发新窗口
});
newPage.waitForLoadState(); // 等待加载完成
```

**API规格：**
```json
// 请求参数
{
  "type": "YUANQI_NAVIGATE_WORKFLOW",
  "engineId": "engine-001",
  "payload": {
    "spaceName": "福帮手开源",    // 空间/团队名称（精确匹配）
    "agentName": "智能助手",      // 智能体名称
    "workflowName": "数据分析"   // 工作流名称
  }
}

// 返回结果
{
  "success": true,
  "data": {
    "message": "成功: 已进入工作流编辑页面",
    "screenshotUrl": "编辑页面截图",
    "currentUrl": "https://yuanqi.tencent.com/bot/workflow/edit/...",
    "spaceName": "福帮手开源",
    "agentName": "智能助手",
    "workflowName": "数据分析"
  }
}
```

---

## <span id="code-structure">📖 代码架构说明</span>

### 项目组织结构

```
controller/yuanqi/           # 控制器层
├── YuanQiLoginController    # 登录消息处理
├── YuanQiWorkflowController # 工作流消息处理
└── 元器使用指南.md          # 技术文档

utils/yuanqi/               # 工具层
├── YuanQiLoginUtil         # 登录业务逻辑
└── YuanQiWorkflowUtil      # 工作流业务逻辑
```

### 架构设计原则

| 设计原则 | 体现方式 | 好处 |
|---------|----------|------|
| **单一职责** | 登录/工作流功能分离 | 代码清晰，便于维护 |
| **分层架构** | Controller处理消息，Util封装逻辑 | 职责明确，复用性强 |
| **依赖注入** | Spring自动管理组件依赖 | 松耦合，易测试 |
| **资源管理** | 自动销毁浏览器会话 | 防内存泄漏，性能优化 |

### 核心组件说明

#### 1. 消息处理流程
```java
@StreamCapability(type = "YUANQI_SCAN_LOGIN")
public void handleScanLogin(EngineMessage message) {
    // 1. 参数提取和验证
    // 2. 获取浏览器会话
    // 3. 执行业务逻辑
    // 4. 流式推送结果
    // 5. 资源清理
}
```

#### 2. 会话管理机制
```java
try {
    session = browserPool.acquirePersistent(userId, "yuanqi", false);
    // 业务操作...
} finally {
    if (session != null) {
        session.destroy(); // 确保释放资源
    }
}
```

#### 3. 截图上传服务
```java
ScreenshotUploadClient.UploadResult result = 
    uploadClient.uploadScreenshot(userId, fileName, screenshotBytes);
```

---

## <span id="troubleshooting">❓ 故障排除指南</span>

### 常见问题速查表

| 问题类型 | 症状 | 解决方案 |
|---------|------|----------|
| 🔐 **登录检测失败** | 返回false但实际已登录 | 增加等待时间，检查DOM变化 |
| 📱 **二维码不显示** | qrCodeUrl为空 | 检查登录弹窗是否正确触发 |
| 🕐 **扫码超时** | 5分钟后自动失败 | 重新发起扫码请求 |
| 🔍 **找不到元素** | 工作流导航中断 | 确认空间/智能体名称精确匹配 |
| 💾 **登录未持久化** | 重启后需重新登录 | 确保等待3秒数据写入 |

### 调试技巧

#### 1. 开启详细日志
```java
log.debug("[元器] 当前页面URL: {}", page.url());
log.debug("[元器] 查找元素: {}", selector);
```

#### 2. 手动检查元素
```javascript
// 在浏览器控制台执行
document.querySelector("aside.yuanqi-sidebar button:has-text('登录')");
```

#### 3. 网络问题排查
- 检查元器网站是否可正常访问
- 验证截图上传服务是否正常
- 确认WebSocket连接状态

#### 4. 性能优化建议
- 避免频繁截图（消耗带宽和存储）
- 合理设置等待时间（平衡速度和稳定性）
- 定期清理浏览器缓存数据

### 错误码对照表

| 错误码 | 含义 | 处理建议 |
|--------|------|----------|
| `TASK_ERROR` | 通用任务错误 | 查看具体错误信息 |
| `TIMEOUT` | 操作超时 | 检查网络连接，重试操作 |
| `NAVIGATION_FAILED` | 页面导航失败 | 确认目标页面可访问 |
| `ELEMENT_NOT_FOUND` | 元素未找到 | 检查页面DOM结构变化 |

### 技术支持

如遇到文档未覆盖的问题：
1. **查看控制台日志** - 获取详细错误信息
2. **截图当前状态** - 便于问题定位
3. **记录复现步骤** - 提供完整的操作序列
4. **检查环境配置** - 确认浏览器版本和系统环境

**调试模式启用：**
```json
// 启用测试查看模式
{"type": "YUANQI_TEST_VIEW", "engineId": "engine-001"}
```

---

**📞 文档更新：** 2025-01-06 | **版本：** v2.0 | **作者：** wxfbsir
```

#### 检测逻辑说明
1. **未登录检测：** 查找左侧菜单是否存在"登录"按钮
   - 如果找到登录按钮 → 返回 `"false"` （未登录）
2. **已登录检测：** 如果没有登录按钮
   - 尝试提取用户名信息 → 返回用户名或 `"已登录"`

---

### 扫码登录流程

**功能说明：** 实时扫码登录，支持二维码自动更新和登录状态监测

#### JSON 请求示例
```json
{
  "type": "YUANQI_SCAN_LOGIN",
  "engineId": "engine-001"
}
```

#### 扫码登录流程图

```
开始登录
    ↓
导航到元器首页
    ↓
检查是否已登录？ ——— 是 ——→ 返回已登录状态
    ↓ 否
触发扫码登录
    ↓
生成二维码截图 ——→ 立即推送给用户
    ↓
每2秒检测登录状态
    ↓
每30秒更新二维码 ——→ 防止二维码过期
    ↓
检测到登录成功？ ——— 否 ——→ 继续等待（最长5分钟）
    ↓ 是
等待数据持久化（3秒）
    ↓
返回登录成功状态
```

#### 流程详细说明

| 步骤 | 操作 | 说明 | 超时时间 |
|------|------|------|----------|
| 1️⃣ | **导航首页** | 访问 `https://yuanqi.tencent.com/` | 30秒 |
| 2️⃣ | **登录检测** | 检查是否已登录，若已登录直接返回 | 即时 |
| 3️⃣ | **触发登录** | 点击左侧菜单"登录"按钮，弹出登录窗口 | 5秒 |
| 4️⃣ | **生成二维码** | 等待2秒后立即截图并推送二维码 | 2秒 |
| 5️⃣ | **状态监测** | 每2秒检测一次登录状态 | 5分钟总超时 |
| 6️⃣ | **二维码更新** | 每30秒更新一次二维码截图 | 持续 |
| 7️⃣ | **登录完成** | 检测到成功后等待3秒数据持久化 | 3秒 |

#### 返回数据结构
```json
{
  "success": true,
  "data": {
    "userName": "用户昵称",
    "qrCodeUrl": "https://admin.server/screenshots/qrcode.png",
    "loginTime": 45,
    "alreadyLoggedIn": false
  }
}
```

---

### 测试查看功能

**功能说明：** 开发者调试专用，打开页面5秒并每秒截图

#### JSON 请求示例
```json
{
  "type": "YUANQI_TEST_VIEW",
  "engineId": "engine-001"
}
```

#### 返回数据结构
```json
{
  "success": true,
  "data": {
    "screenshots": [
      "https://admin.server/screenshots/test_1.png",
      "https://admin.server/screenshots/test_2.png",
      "..."
    ],
    "loginStatus": "已登录" | "未登录",
    "isLoggedIn": true,
    "testDuration": 5,
    "platform": "YuanQi"
  }
}
```

---

## 🔄 工作流导航操作

### 工作流导航流程

**功能说明：** 自动导航到指定工作流的编辑页面

#### JSON 请求示例
```json
{
  "type": "YUANQI_NAVIGATE_WORKFLOW",
  "engineId": "engine-001",
  "payload": {
    "spaceName": "福帮手开源",
    "agentName": "123",
    "workflowName": "分析助手-高优先级-多模型"
  }
}
```

#### 导航步骤详解

```
导航开始
    ↓
1️⃣ 点击"个人空间"按钮 ——→ 展开空间选择弹窗
    ↓
2️⃣ 选择指定空间/团队 ——→ 点击"福帮手开源"
    ↓
3️⃣ 展开智能体列表 ——→ 点击"我的智能体"或"团队智能体"
    ↓
4️⃣ 选择指定智能体 ——→ 点击"123"智能体卡片
    ↓
5️⃣ 进入智能体详情页 ——→ 点击"工作流管理"标签
    ↓
6️⃣ 查找目标工作流 ——→ 在列表中找到"分析助手-高优先级-多模型"
    ↓
7️⃣ 点击编辑按钮 ——→ 打开新窗口进入工作流编辑页面
    ↓
8️⃣ 截图并返回结果
```

#### 参数说明

| 参数名 | 类型 | 必填 | 说明 | 示例值 |
|--------|------|------|------|--------|
| `spaceName` | String | ✅ | 空间/团队名称 | `"个人空间"` `"福帮手开源"` `"U3W优立方"` |
| `agentName` | String | ✅ | 智能体名称 | `"123"` `"配置简化"` `"潜力眼【内测】"` |
| `workflowName` | String | ✅ | 工作流名称 | `"分析助手-高优先级-多模型"` |

#### 返回数据结构
```json
{
  "success": true,
  "data": {
    "message": "成功: 已进入工作流编辑页面 - 分析助手-高优先级-多模型",
    "screenshotUrl": "https://admin.server/screenshots/workflow_edit.png",
    "currentUrl": "https://yuanqi.tencent.com/bot/workflow/edit/...",
    "spaceName": "福帮手开源",
    "agentName": "123",
    "workflowName": "分析助手-高优先级-多模型",
    "timestamp": 1736144400000
  }
}
```

---

## 🧪 调试与测试

### 使用 Debug 页面进行测试

#### 访问路径
前端调试页面位于：`/src/views/business/debug`

#### 测试步骤

1. **打开 Debug 页面**
   - 在浏览器中访问调试页面
   - 输入对应的JSON请求数据

2. **登录检测测试**
   ```json
   {
     "type": "YUANQI_CHECK_LOGIN",
     "engineId": "engine-001"
   }
   ```

3. **扫码登录测试**
   ```json
   {
     "type": "YUANQI_SCAN_LOGIN",
     "engineId": "engine-001"
   }
   ```

4. **工作流导航测试**
   ```json
   {
     "type": "YUANQI_NAVIGATE_WORKFLOW",
     "engineId": "engine-001",
     "payload": {
       "spaceName": "个人空间",
       "agentName": "测试智能体",
       "workflowName": "测试工作流"
     }
   }
   ```

#### 测试注意事项

- ✅ **确保网络畅通** - 元器网站需要正常访问
- ✅ **浏览器持久化** - 登录状态会保存在用户数据目录
- ✅ **截图上传** - 所有截图会自动上传到Admin服务器
- ✅ **会话管理** - 每次操作完成后会自动销毁会话释放资源

---

## 📖 代码结构说明

### 项目结构

```
controller/
└── yuanqi/
    ├── YuanQiLoginController.java      # 登录控制器
    ├── YuanQiWorkflowController.java   # 工作流控制器
    └── 元器使用指南.md                  # 本文档

utils/
└── yuanqi/
    ├── YuanQiLoginUtil.java            # 登录工具类
    └── YuanQiWorkflowUtil.java         # 工作流工具类
```

### 核心组件说明

#### 1. 登录控制器 (`YuanQiLoginController`)
- **职责：** 处理登录相关的WebSocket消息
- **功能：** 登录检测、扫码登录、测试查看
- **依赖：** `YuanQiLoginUtil`、`BrowserPoolManager`、截图上传服务

#### 2. 工作流控制器 (`YuanQiWorkflowController`)
- **职责：** 处理工作流导航相关操作
- **功能：** 工作流页面导航、智能体管理
- **依赖：** `YuanQiWorkflowUtil`、`YuanQiLoginUtil`

#### 3. 登录工具类 (`YuanQiLoginUtil`)
- **职责：** 封装登录相关的底层操作
- **功能：** 页面导航、登录状态检测、扫码触发

#### 4. 工作流工具类 (`YuanQiWorkflowUtil`)
- **职责：** 封装工作流操作的底层实现
- **功能：** 复杂页面导航、文本内容点击

### 设计原则

- ✅ **单一职责** - 每个类专注于特定功能领域
- ✅ **清晰分层** - Controller处理消息，Util封装业务逻辑
- ✅ **良好封装** - 工具方法复用性强，减少重复代码
- ✅ **易于维护** - 结构清晰，便于后续扩展和修改

---

## ❓ 常见问题解决

### 登录相关问题

#### Q1: 登录检测返回false但实际已登录？
**A:** 可能是页面加载不完整，建议：
- 增加等待时间 `page.waitForTimeout(5000)`
- 检查DOM选择器是否正确
- 查看是否有新的页面结构变化

#### Q2: 扫码登录二维码无法显示？
**A:** 检查以下几点：
- 确保触发登录成功
- 检查iframe是否加载完成
- 确认截图上传服务正常运行

#### Q3: 登录成功但状态未持久化？
**A:** 登录成功后需要等待数据写入：
```java
// 等待Chromium完成数据持久化
Thread.sleep(3000);
```

### 工作流导航问题

#### Q1: 找不到指定的空间/团队？
**A:** 确认以下信息：
- 空间名称拼写完全正确
- 用户确实有该空间的访问权限
- 空间是否处于激活状态

#### Q2: 智能体列表未展开？
**A:** 可能的解决方案：
- 增加点击后的等待时间
- 检查菜单项的CSS选择器
- 确认"我的智能体"或"团队智能体"菜单存在

#### Q3: 工作流编辑页面未打开？
**A:** 检查点击操作：
- 确认工作流名称精确匹配
- 检查编辑按钮是否可点击
- 确认新窗口监听事件正常

### 性能优化建议

#### 1. 会话管理
```java
// 正确的会话管理
try {
    session = browserPool.acquirePersistent(userId, "yuanqi", false);
    // 业务逻辑...
} finally {
    if (session != null) {
        session.destroy(); // 确保释放资源
    }
}
```

#### 2. 截图优化
- 避免频繁截图，合理控制截图间隔
- 截图失败时有降级处理方案
- 定期清理服务器上的截图文件

#### 3. 等待时间优化
- 使用智能等待替代固定等待
- 根据网络状况动态调整超时时间
- 添加重试机制处理临时网络问题

---

## 🎯 初学者快速上手

### 第一步：理解基本概念
- **元器** = 腾讯的AI平台
- **扫码登录** = 使用微信扫描二维码登录
- **工作流** = 智能体的业务流程配置

### 第二步：运行第一个测试
1. 复制登录检测的JSON到debug页面
2. 点击发送，观察返回结果
3. 理解 `isLoggedIn` 字段的含义

### 第三步：尝试扫码登录
1. 确保未登录状态
2. 发送扫码登录请求
3. 扫描返回的二维码完成登录

### 第四步：测试工作流导航
1. 确保已登录状态
2. 准备真实的空间、智能体、工作流名称
3. 发送导航请求并观察新打开的页面

### 学习路径推荐
1. 📖 **阅读本指南** - 理解整体架构和功能
2. 🧪 **Debug页面实践** - 通过实际操作加深理解  
3. 📝 **查看代码实现** - 学习具体的技术细节
4. 🛠️ **自定义扩展** - 根据需求添加新功能

---

**📞 技术支持：** 如遇到问题，请检查日志输出并参考本指南的常见问题部分。
