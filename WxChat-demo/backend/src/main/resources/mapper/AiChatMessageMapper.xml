<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.demo.wxchat.mapper.AiChatMessageMapper">

    <resultMap type="com.demo.wxchat.domain.AiChatMessage" id="AiChatMessageResult">
        <result property="id" column="id"/>
        <result property="sessionId" column="session_id"/>
        <result property="role" column="role"/>
        <result property="content" column="content"/>
        <result property="messageId" column="message_id"/>
        <result property="isRead" column="is_read"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <select id="selectByMessageId" parameterType="String" resultMap="AiChatMessageResult">
        select * from ai_chat_message where message_id = #{messageId} limit 1
    </select>

    <select id="selectUnreadMessages" parameterType="String" resultMap="AiChatMessageResult">
        select * from ai_chat_message
        where session_id = #{sessionId} and is_read = 0 and role = 'assistant'
        order by create_time asc
    </select>

    <insert id="insert" parameterType="com.demo.wxchat.domain.AiChatMessage" useGeneratedKeys="true" keyProperty="id">
        insert into ai_chat_message (session_id, role, content, message_id, is_read, create_time)
        values (#{sessionId}, #{role}, #{content}, #{messageId}, #{isRead}, now())
    </insert>

    <update id="markAsRead">
        update ai_chat_message
        set is_read = 1, update_time = now()
        where session_id = #{sessionId}
        <if test="ids != null and ids.size() > 0">
            and id in
            <foreach item="id" collection="ids" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
    </update>
</mapper>
