# 潜力眼 完整部署指南

## 项目简介
这是一个**嵌入福帮手内部的HR智能助手应用**。

**核心功能**：
- 🔐 **企业微信 OAuth 登录**：用户通过企业微信授权登录
- 🤖 **元器 AI 对话**：通过Nginx反向代理转发请求，实现与元器AI的实时对话，并解析用户上传的简历文件

- **技术架构**：
- 前端：Vue 3 + Element Plus
- 后端：Spring Boot + MyBatis
- 数据库：MySQL 5.7+
- 部署：Nginx 反向代理
---

## 目录

1. [部署前准备](#部署前准备)
2. [企业微信配置](#企业微信配置)
3. [服务器环境配置](#服务器环境配置)
4. [Nginx配置（第一阶段）](#nginx配置第一阶段)
5. [元器配置](#元器配置)
6. [Nginx配置（第二阶段）](#nginx配置第二阶段)
7. [后端配置与部署](#后端配置与部署)
8. [前端构建与部署](#前端构建与部署)

---

## 部署前准备

### 必需资源

| 资源 | 要求 | 说明 |
|------|------|------|
| **域名** | 必须与企业微信主体一致 | 需向企业微信管理员申请，用于OAuth回调 |
| **服务器** | 1核2G以上 | 需要公网IP，建议使用宝塔面板 |
| **SSL证书** | 必须 | 企业微信要求HTTPS，可使用Let's Encrypt免费证书 |
| **企业微信账号** | 管理员权限 | 用于创建应用和配置 |
| **元器账号** | 已注册 | 用于创建智能体 |

### 环境要求

| 环境 | 版本 |
|------|------|
| JDK | 17+ |
| Maven | 3.6+ |
| Node.js | 18+ |
| MySQL | 5.7+ / 8.0+ |
| Nginx | 任意版本 |

---

## 企业微信配置

### 步骤1：获取企业ID

1. 登录 [企业微信管理后台](https://work.weixin.qq.com/wework_admin/frame#/)
2. 点击左侧菜单 **我的企业**
3. 在页面底部找到 **企业ID (corpId)**，记录下来

### 步骤2：创建自建应用

1. 点击左侧菜单 **应用管理**
2. 点击 **自建** → **创建应用** 这里注意：创建两个应用，一个是主应用，一个辅助应用】
3. 填写应用信息：
    - 应用名称：如 "AI对话助手"
    - 应用Logo：上传图标
    - 可见范围：选择需要使用的部门或成员
4. 创建成功后，记录以下信息：
    - **AgentId**（应用ID）
    - **Secret**（应用密钥，点击"查看"获取）

---

## 服务器环境配置

### 步骤1：域名解析

1. 登录域名管理后台
2. 添加A记录：
    - 主机记录：`abc` 或 `123`
    - 记录类型：`A`
    - 记录值：服务器公网IP
    - TTL：默认

### 步骤2：安装宝塔面板（推荐）

[宝塔](https://www.bt.cn/u/PXnXfi)官网

### 步骤3：安装必需软件

在宝塔面板中安装：
- Nginx（任意版本）
- MySQL 8.0
- Java项目管理器（用于运行Spring Boot）
- redis 8版本
---

## Nginx配置（第一阶段）

**目的**：配置企业微信代理和元器回调代理，用于创建元器发布渠道

### 步骤1：创建网站

1. 宝塔面板 → **网站** → **添加站点**
2. 填写配置：
    - 域名：你的域名（如 `demo.example.com`）
    - 根目录：`/www/wwwroot/demo.example.com`
    - PHP版本：纯静态

### 步骤2：配置SSL证书

1. 点击网站 → **SSL**
2. 选择 **Let's Encrypt** 免费证书
3. 勾选域名 → **申请**
4. 开启 **强制HTTPS**

**⚠️ 必须配置SSL证书，否则企业微信无法回调！**

### 步骤3：配置Nginx反向代理

点击网站 → **配置文件**，在 `server` 块中添加以下配置：

```nginx
# 前端路由支持（Vue Router history模式）
location / {
    try_files $uri $uri/ /index.html;
}

# 企业微信API代理
location ~ ^/cgi-bin/ {
    proxy_pass              https://qyapi.weixin.qq.com;
    proxy_http_version      1.1;
    proxy_set_header        Connection "close";
    proxy_buffering         off;
    proxy_read_timeout      600s;
    proxy_send_timeout      600s;
}

# 元器回调代理（用于创建发布渠道）
location ~ ^/api/v2/channel/callback/wecom/message/ {
    proxy_pass              https://yuanqi.tencent.com;
    proxy_http_version      1.1;
    proxy_set_header        Connection "close";
    proxy_buffering         off;
    proxy_read_timeout      600s;
    proxy_send_timeout      600s;
}
```

保存并重启Nginx。

---

## 元器配置

### 步骤1：创建智能体

1. 登录 [腾讯元器](https://yuanqi.tencent.com/)
2. 点击 **创建智能体** → 选择 **对话式智能体**  【注意】在腾讯元气中创建的智能体为单工作流模式
3. 填写基本信息并创建

### 步骤2：导入工作流

1. 点击顶部 **工作流管理**
2. 点击 **导入工作流**
3. 上传 `export-AI-HR智能助手【子节点】.zip;export-AI-HR智能助手等.zip` 文件
4. 导入成功后，点击 **编辑**

### 步骤3：修改工作流节点

找到 **"向对话信息存储到数据库"** HTTP请求节点：

1. 修改请求地址：
   ```
   https://你的域名/api/chat/workflow/callback
   ```
2. 保存节点
3. 点击 **调试** 测试工作流
4. 测试成功后，点击 **返回** 并 **启用工作流**

### 步骤4：创建企业微信发布渠道

1. 进入 **应用发布** 页面
2. 点击 **发布渠道** → **创建发布渠道**
3. 选择 **企业微信应用**
4. 填写配置：
    - **企业ID (CorpId)**：之前记录的企业ID
    - **应用ID (AgentId)**：之前记录的应用AgentId 【副应用】
    - **应用密钥 (Secret)**：之前记录的Secret 【副应用】
    - **服务器地址 (URL)**：将 `{您的域名}` 替换为你的域名
      ```
      https://你的域名/api/v2/channel/callback/wecom/message/
      ```
    - **注意**：在创建完成企业微信发布通道后，在企业微信中记得关闭【副应用】，解决企业微信控制台消息露出的问题

5. 点击 **创建**

### 步骤6：获取元器配置信息

创建成功后，点击 **查看详情**，记录以下信息：

- **服务器地址 (URL)**：如 `https://你的域名/api/v2/channel/callback/wecom/message/{channelId}`  # 企业微信通道发布后的/message/后面的数字
- **Token**：消息验证Token
- **EncodingAESKey**：AES加密密钥（43位）

**⚠️ 重点**：记录URL中 `/message/` 后面的数字为channelId 

---

## Nginx配置（第二阶段）

**目的**：将元器回调代理改为后端API代理

### 步骤1：修改Nginx配置

点击网站 → **配置文件**，找到之前添加的元器代理配置，**删除**：

```nginx
# 删除这段配置
location ~ ^/api/v2/channel/callback/wecom/message/ {
    proxy_pass              https://yuanqi.tencent.com;
    ...
}
```

**删除后完整的nginx配置信息**： 
注意：/www/wwwroot/WxFbsir这个为文件上传路径地址，使用nginx代理，使上传的文件可以被工作流解析。
```nginx
location /files/ {
        # 1. 基本路径设置
        root /www/wwwroot/WxFbsir;
        autoindex on;
        autoindex_exact_size off;  # 人性化显示文件大小
        autoindex_localtime on;    # 使用服务器本地时间
        
        # 2. 字符编码设置
        charset utf-8;
        
        # 3. 缓存控制
        location ~* \.pdf$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
            add_header Content-Type "application/pdf";
        }
        
        # 4. 安全设置
        location ~ /\. {
            deny all;  # 禁止访问隐藏文件
        }
        
        location ~* \.(php|asp|aspx|jsp|cgi|sh|pl|py)$ {
            deny all;  # 禁止脚本文件
            return 403;
        }
        
        # 5. 跨域配置
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, HEAD";
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range";
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type "text/plain; charset=utf-8";
            add_header Content-Length 0;
            return 204;
        }
        
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, HEAD";
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range";
        add_header Access-Control-Expose-Headers "Content-Length,Content-Range";
        
        # 6. 安全头部
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        # 7. 文件上传限制
        client_max_body_size 50M;  # 允许最大上传50MB文件
        
        # 8. 下载速率限制
        # limit_rate 500k;  # 限速500KB/s
        
        # 9. 文件访问优化
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        
        # 10. 错误处理
        error_page 403 = /403.html;
        error_page 404 = /404.html;
        
        # 11. 日志记录
        access_log /www/wwwlogs/mcs.u3w.com_files_access.log;
        error_log /www/wwwlogs/mcs.u3w.com_files_error.log;
    }
    
    #REWRITE-END
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 企业微信API代理
    location ~ ^/cgi-bin/ {
        proxy_pass              https://qyapi.weixin.qq.com;
        proxy_http_version      1.1;
        proxy_set_header        Connection "close";
        proxy_buffering         off;
        proxy_read_timeout      600s;
        proxy_send_timeout      600s;
    }
    
    location /api/ {
        proxy_pass              http://127.0.0.1:8080;
        proxy_http_version      1.1;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_set_header        REMOTE-HOST $remote_addr;
    
        # 通用超时配置
        proxy_connect_timeout   30s;
        proxy_read_timeout      86400s;
        proxy_send_timeout      30s;
    
        # 缓冲配置
        proxy_buffering         off;
    }
```

**⚠️ 注意**：端口 `8080` 必须与后端配置的端口一致！

### 步骤2：配置企业微信验证文件

添加以下配置（用于企业微信网页授权验证）：

```nginx
location ~*\.txt$ {
    root /www/wwwroot/你的域名/dist/;
}
```

保存并重启Nginx。

---

## 后端配置与部署

### 步骤1：配置数据库

1. 宝塔面板 → **数据库** → **添加数据库**
2. 数据库名：`wxfbsir`
3. 用户名：自定义
4. 密码：自定义
5. 执行初始化脚本：

```
  执行数据库文件【potential-eye.sql】，在原有的福帮手数据库中
```

### 步骤2：修改配置文件

编辑 `backend/src/main/resources/application.yml`：

```yaml

# 数据库配置
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/demo?useUnicode=true&characterEncoding=utf8&serverTimezone=GMT%2B8
    username: 你的数据库用户名
    password: 你的数据库密码

# 企业微信配置（用于调用企业微信API，如获取用户信息等）
wework:
  corp-id: #你的企业ID
  agent-id: #你的应用AgentId【主应用】
  agent-secret: # 你的应用Secret 【主应用】

# 元器AI配置（用于发送消息到元器平台）
yuanqi:
  # 消息加密Token
  token: #元器提供的Token
  # AES加密密钥（43位）
  encoding-aes-key: # 元器提供的EncodingAESKey
  # 元器回调地址（需要替换实际的channelId）
  target-url: https://yuanqi.tencent.com/api/v2/channel/callback/wecom/message/{channelId}  # 企业微信通道发布后的/message/后面的数字
  # 模拟企业微信发送消息时使用的企业ID和应用ID（用于构造消息体）
  # 如果与上面wework配置相同，可以留空，系统会自动使用wework的配置
  # 正常不需要考虑配置下面两个
  corp-id: #你的企业ID
  agent-id: #你的应用AgentId【副应用】
# 上传的文件地址配置
wxfbsir:
  profile: /www/wwwroot/WxFbsir [暴露的位置要与Nginx中的配置相同]
  domain: https://你的域名
```

**⚠️ 重要配置说明**：

1. **target-url**：
    - 前面部分 `https://yuanqi.tencent.com/api/v2/channel/callback/wecom/message/` 不可更改
    - 只需将 `/message/` 后面的数字替换为你的channelId
    - 示例：`https://yuanqi.tencent.com/api/v2/channel/callback/wecom/message/{channelId}`


### 步骤3：本地打包

在本地开发环境执行：

```bash
mvn clean package -DskipTests
```

打包完成后，在 `WxFbsir-admin/target/` 目录下生成 `WxFbsir-admin.jar`

### 步骤4：上传到服务器

1. 宝塔面板 → **文件**
2. 创建目录：`/www/wwwroot/WxFbsir/`
3. 上传 `WxFbsir-admin.jar`

### 步骤5：启动后端

1. 宝塔面板 → **Java项目管理器**
2. 添加项目：
    - 项目路径：`/www/wwwroot/WxFbsir/`
    - JAR包：`WxFbsir-admin.jar`
    - 启动端口：`8080`
3. 点击 **启动**
---

## 前端构建与部署

### 步骤1：本地构建

在本地开发环境执行：

```bash
cd WxFbsir-front
npm install
npm run build
```

构建完成后，`dist` 目录下生成静态文件。

### 步骤2：上传到服务器

1. 宝塔面板 → **文件**
2. 进入网站目录：`/www/wwwroot/你的域名/`
3. 将 `dist` 目录下的 **所有文件** 上传到该目录

---

## 企业微信应用配置

### 步骤1：配置网页授权及JS-SDK

1. 进入企业微信应用详情页
2. 找到 **网页授权及JS-SDK** 区域
3. 点击 **设置可信域名**
4. 填入你的域名（不带协议和端口），如：`demo.example.com`
5. 下载验证文件（如 `WW_verify_xxx.txt`）
6. 将验证文件上传到 `/www/wwwroot/你的域名/dist/` 目录
7. 点击 **验证**

### 步骤2：配置OAuth回调域

1. 在应用详情页，找到 **企业微信授权登录** 区域
2. 点击 **设置授权回调域**
3. 填入你的域名（不带协议和端口）

### 步骤3：配置可信IP

1. 在应用详情页，找到 **企业可信IP** 区域
2. 点击 **配置**
3. 填入服务器公网IP

### 步骤4：配置应用首页

1. 在应用详情页，找到 **应用主页** 区域
2. 填入：`https://你的域名`
3. 保存

---

## 验证部署

### 1. 访问应用

在企业微信中打开应用

### 2. 测试企业微信登录

1. 点击 **通过企业微信登录**
2. 如果用户已经注册，直接跳转到对话页面
3. 如果用户未注册，则跳转到注解页面，注册成功后，跳转到对话页面 
4. 发送消息测试

### 3. 检查数据库

```sql
SELECT * FROM chat_message ORDER BY create_time DESC LIMIT 10;
```

应该能看到用户消息和AI回复记录。

---
