  

  

**项目名称**：积分系统扩展与优化  

  

  

**文档版本**：v2.0

  

  

**编写日期**：2025-01-XX（已更新至v2.0，反映已完成功能）  

  

  

**编写人**：苏飞扬

  

  

  

---

  

  

  

## 一、现状分析

  

  

  

### 1.1 当前积分系统架构

  

  

  

**技术栈**：

  

  

- 后端框架：Spring Boot + MyBatis

  

  

- 数据库：MySQL

  

  

- 缓存：Redis

  

  

- 项目结构：Maven 多模块项目（cube-admin、cube-point、cube-system、cube-common、cube-framework等）

  

  

  

**核心表结构**：

  

  

- `sys_user.points`：用户积分余额字段

  

  

- `wc_points_record`：积分变动明细表

  

  

- `sys_dict_data`：积分规则配置表（dict_type='sys_point_rule'）

  

  

  

**现有功能**：

  

  

1. **积分发放**：通过 `setUserPoint()` 方法实现，支持异步处理

  

  

2. **积分查询**：用户积分余额查询、积分明细查询

  

  

3. **规则配置**：通过 `sys_dict_data` 表配置积分规则（dict_value 存储积分值），已从字典管理迁移至积分管理菜单，提供专门的积分规则配置界面

  

  

4. **规则校验**：已实现基于 Redis 的原子性限频检查，支持每日/每周/每月/总额度等多维限频，通过 `remark` 字段存储 JSON 配置实现灵活配置

  

  

5. **积分负数校验**：在积分扣减时实现余额校验，防止积分余额出现负数，扣减前检查余额是否充足

  

  

6. **登录奖励**：支持首次登录和每日登录积分奖励

  

  

7. **积分任务清单**：提供 `getPointTaskList()` 接口，展示所有可获取积分的任务，包含任务名称、积分值、限频信息、完成状态等

  

  

8. **积分总览**：提供 `getUserPointsSummary()` 接口，展示用户积分余额、今日获得、本周获得、最近变动等统计信息

  

  

9. **模板市场闭环**：实现了完整的模板生态，包括：

  - **我的模板箱**：用户查看自己创建的模板和购买的模板

  - **模板市场**：展示所有上架的模板，支持模板购买、搜索、筛选等功能

  - **模板工作坊**：用户创建和编辑评分模板、提示词模板，支持上架到市场

  

  

10. **积分管理菜单**：新增积分管理模块，包含：

  - **我的积分总览**：展示用户积分统计和明细

  - **积分规则配置**：运营人员配置积分规则，支持限频配置、积分值配置等

  

  

  

**现有积分规则类型**：

  

  

- 首次登录

  

  

- 每日优立方登录

  

  

- 使用F8S（AI助理消耗）

  

  

- 记忆修改

  

  

- 模板配置

  

  

- 其他业务场景积分规则

  

  

  


## 二、积分系统总体目标分解

  

  

  

### 2.1 总体目标

  

  

  

构建一个**流动性强、场景丰富、运营灵活、激励完善**的积分生态系统，提升用户活跃度、增强平台价值、促进生态合作。

  

  

  

### 2.2 目标分解

  

  

  

#### 2.2.1 用户侧目标

  

  

- **提升积分流动性**：实现用户积分交易

  

  

  

  

- **增强用户粘性**：通过积分激励提升用户活跃度和留存率

  

  

  

#### 2.2.2 运营侧目标

  

  

- ✅ **规则配置优化**：积分规则配置已从字典管理迁移至积分管理，提供专门配置界面（已完成）

  

  


  

  



  

  

- ✅ **模板市场抽佣**：模板购买时平台抽取佣金，已实现（已完成）

  

  



  

  

  

#### 2.2.3 合作伙伴侧目标

  

  

- ✅ **模板市场闭环**：模板创建、上架、购买全流程已实现，模板作者可通过上架模板获得积分收益（已完成）

  

  

- ✅**内容贡献激励**：提示词模板上架可获得积分奖励

  

  



  

  

  

#### 2.2.4 技术侧目标

  

  



  

  


  

  

- ✅ **可扩展性**：积分规则配置已优化，通过JSON配置支持多维限频，配置方式更加灵活（已完成）

  

  

- ✅ **数据安全**：积分负数校验已实现，防止积分余额出现负数（已完成）

  

- ✅ **可扩展性**：积分规则配置已优化，通过JSON配置支持多维限频，配置方式更加灵活（已完成）

  

  

- ✅ **数据安全**：积分负数校验已实现，防止积分余额出现负数（已完成）

  

  

  

---

  

  

  

## 三、计划覆盖的目标场景清单

  

  

  

### 3.1 用户侧场景

  

  

  

| 场景编号 | 场景名称 | 场景描述 | 优先级 |

  

  

|---------|---------|---------|--------|


  

| U-001 | 积分明细查询 | 用户查看积分收入、支出、转让、抽奖等明细记录 | P0 | ✅ |

  

  

| U-002 | 积分余额查询 | 用户实时查看当前积分余额 | P0 | ✅ |

  

  

| U-003 | 积分任务清单 | 用户查看所有可获取积分的任务，了解任务完成状态 | P0 | ✅ |

  

  

| U-004 | 积分总览 | 用户查看积分余额、今日获得、本周获得等统计信息 | P0 | ✅ |

  

  

| U-005 | 模板市场 | 用户浏览、搜索、购买模板，完成模板交易闭环 | P0 | ✅ |

  

  

| U-006 | 模板工作坊 | 用户创建、编辑、上架模板到市场 | P0 | ✅ |

  

  

| U-007 | 我的模板箱 | 用户管理自己创建的模板和购买的模板 | P0 | ✅ |

  

  

  



  

  


  

  


  

  

  

## 四、具体方案

  

  

  

### 4.0 已完成功能

  

  

#### 4.0.1 积分负数校验功能

  

  

**功能描述**：

  

  

在积分扣减操作时，系统会先查询用户当前积分余额，如果扣减后余额将小于0，则直接阻断操作并返回错误提示，防止积分余额出现负数。

  

  

**技术实现**：

  

  

- 在 `setUserPoint()` 方法中，扣减场景（`actualChange < 0`）时先行校验

  - 查询当前积分余额：`pointsMapper.getUserPoints(userId)`

  - 计算扣减后余额：`currentPoints + actualChange`

  - 如果结果小于0，返回错误："积分余额不足，扣减失败"

  

  

**核心代码逻辑**：

  

  

```java

  

// 扣减场景时先行校验，余额不足直接阻断

  

if (actualChange < 0 && (currentPoints + actualChange) < 0) {

  

    return ResultBody.error(400, "积分余额不足，扣减失败");

  

}

  

```

  

  

#### 4.0.2 积分规则限频校验功能

  

  

**功能描述**：

  

  

基于Redis实现积分规则的限频检查，支持每日/每周/每月/总额度等多维限频，通过JSON配置实现灵活配置。

  

  

**技术实现**：

  

  

- **限频类型**：支持 `DAILY`（每日）、`WEEKLY`（每周）、`MONTHLY`（每月）、`TOTAL`（总额度）、`NONE`（不限频）

  

  

- **限频Key格式**：`points:limit:{changeType}:{userId}:{dateKey}`

  

  

- **限频检查流程**：

  1. 解析规则配置中的 `remark` 字段（JSON格式），获取 `limitType` 和 `limitValue`

  2. 根据限频类型构建Redis Key

  3. 使用 `INCR` 操作增加计数，首次设置时设置过期时间

  4. 如果计数超过限频值，返回错误

  

  

- **累计上限检查**：支持 `maxAmount` 配置，检查累计获得积分是否超过上限

  

  

**核心代码逻辑**：

  

  

```java

  

// 限频校验

  

if (!checkLimit(userId, changeType, limitConfig)) {

  

    return ResultBody.error(429, "积分规则达到领取上限，请稍后再试");

  

}

  

// 累积金额校验

  

if (!checkMaxAmount(userId, changeType, actualChange, limitConfig)) {

  

    return ResultBody.error(429, "已达到积分累计上限，无法继续发放");

  

}

  

```

  

  

#### 4.0.3 积分规则配置优化

  

  

**功能描述**：

  

  

将积分规则配置从"字典管理"迁移至"积分管理"菜单，提供专门的积分规则配置界面，优化配置体验。

  

  

**实现内容**：

  

  

- 新增菜单项："积分管理" > "积分规则配置"（菜单ID：2112）

  

  

- 前端页面：`cube-ui/src/views/points/rule/index.vue`

  

  

- 功能特性：

  - 支持新增、编辑、删除积分规则

  - 支持配置积分值（`dict_value`）

  - 支持配置限频规则（通过 `remark` 字段存储JSON配置）

  - 支持配置规则状态（启用/停用）

  

  

#### 4.0.4 积分任务清单功能

  

  

**功能描述**：

  

  

提供积分任务清单接口，展示所有可获取积分的任务，包含任务名称、积分值、限频信息、完成状态等，帮助用户了解积分获取途径。

  

  

**技术实现**：

  

  

- **接口**：`GET /getPointTaskList`

  

  

- **功能特性**：

  - 返回所有积分规则配置的任务

  - 自动解析限频配置，转换为用户友好的描述

  - 如果用户已登录，自动判断任务完成状态

  - 支持任务分类（每日任务、创作任务、消费任务、互动任务等）

  - 支持任务图标展示

  

  

- **任务完成状态判断**：

  - 对于一次性任务（TOTAL类型且limitValue=1），查询数据库记录

  - 对于限频任务，查询Redis计数器

  - 如果Redis中没有记录，再查询数据库作为补充

  

  

**核心代码逻辑**：

  

  

```java

  

@GetMapping("/getPointTaskList")

  

public ResultBody getPointTaskList() {

  

    List<Map<String, Object>> taskList = pointsMapper.getPointTaskList();

  

    // 处理每个任务，解析限频配置

  

    for (Map<String, Object> task : taskList) {

  

        // 解析限频配置

  

        // 判断任务完成状态

  

        // 设置任务图标和分类

  

    }

  

    return ResultBody.success(taskList);

  

}

  

```

  

  

#### 4.0.5 我的积分总览功能

  

  

**功能描述**：

  

  

提供用户积分总览接口，展示用户积分余额、今日获得、本周获得、最近变动等统计信息。

  

  

**技术实现**：

  

  

- **接口**：`GET /getUserPointsSummary?userId={userId}`

  

  

- **返回数据**：

  - `balance`：当前积分余额

  - `todayGain`：今日获得积分（仅统计正向积分）

  - `weekGain`：本周获得积分（仅统计正向积分）

  - `lastChange`：最近一次积分变动记录

  

  

- **前端页面**：`cube-ui/src/views/points/overview/index.vue`

  

  

- **菜单位置**："积分管理" > "我的积分总览"（菜单ID：2111）

  

  

#### 4.0.6 模板市场闭环功能

  

  

**功能描述**：

  

  

实现了完整的模板生态闭环，包括模板创建、上架、购买、使用等全流程，支持评分模板和提示词模板两种类型。

  

  

**技术实现**：

  

  

**1. 我的模板箱**（`cube-ui/src/views/wechat/templateBox/index.vue`）

  

  

- 展示用户创建的模板列表（CreatedList组件）

  

  

- 展示用户购买的模板列表（PurchasedList组件）

  

  

- 支持模板编辑、删除、上架等操作

  

  

**2. 模板市场**（`cube-ui/src/views/wechat/templateMarket/index.vue`）

  

  

- 展示所有上架到市场的模板

  

  

- 支持模板搜索、筛选（按类型、价格、评分等）

  

  

- 支持模板购买功能，购买时：

  - 扣减购买者积分

  - 增加作者积分（扣除平台抽成）

  - 增加平台账户积分（平台抽成，userid=0）

  - 记录购买记录到 `wc_template_purchase` 表

  

  

**3. 模板工作坊**（`cube-ui/src/views/wechat/templateWorkshop/index.vue`）

  

  

- 支持创建和编辑评分模板

  

  

- 支持创建和编辑提示词模板

  

  

- 支持模板上架到市场（设置 `status=1`，`price` 等字段）

  

  

- 保存成功后保持在当前页面，不进行路由跳转

  

  

**数据库表**：

  

  

- `wc_prompt_template`：评分模板表，已扩展字段 `price`、`status`、`sales_count`、`income_total`

  

  

- `wc_call_word`：提示词模板表，已扩展字段 `price`、`status`、`sales_count`、`income_total`

  

  

- `wc_template_purchase`：模板购买记录表，记录购买信息、作者收益、平台抽成等

  

  

**核心流程**：

  

  

1. **模板创建**：用户在模板工作坊创建模板

  

  

2. **模板上架**：用户设置模板价格和状态，上架到市场

  

  

3. **模板购买**：其他用户在模板市场购买模板，系统自动处理积分分配

  

  

4. **模板使用**：购买后的模板出现在"我的模板箱"中，可供使用

  

  

---

  

  

  

## 五、技术思路

  

  

  

### 5.1 架构设计

  

  

  

#### 5.1.1 整体架构

  

  

采用**事件驱动 + 异步处理 + 缓存优化**的架构模式：

  

  

  

```

  

  

┌─────────────┐

  

  

│  业务模块   │  (积分转让、抽奖、模板等)

  

  

└──────┬──────┘

  

  

       │ 发布事件

  

  

       ▼

  

  

┌─────────────┐

  

  

│ 事件总线    │  (Spring Event / MQ)

  

  

└──────┬──────┘

  

  

       │ 订阅事件

  

  

       ▼

  

  

┌─────────────┐

  

  

│ 积分服务    │  (PointsSystem)

  

  

│ - 规则校验  │

  

  

│ - 积分发放  │

  

  

│ - 积分扣减  │

  

  

└──────┬──────┘

  

  

       │

  

  

       ├──► Redis (缓存、分布式锁、限频)

  

  

       └──► MySQL (持久化)

  

  

```

  

  

  

#### 5.1.2 模块划分

  

  

- **cube-point**：积分核心模块（规则校验、积分发放、积分查询）

  


  

  



  

  

  

### 5.2 技术选型

  

  

  

#### 5.2.1 事件驱动

  

  

- **方案1**：Spring Event（同步/异步事件）

  

  

  - 优点：轻量级，无需额外中间件

  

  

  - 缺点：单机内事件，不支持分布式

  

  

- **方案2**：消息队列（RabbitMQ / RocketMQ）

  

  

  - 优点：支持分布式，可靠性高



  

  

  

#### 5.2.2 分布式锁

  

  

- **Redis分布式锁**：使用 `SET key value NX EX timeout` 实现

  

  



  

  

  

#### 5.2.3 缓存策略

  

  

- **积分余额**：Redis缓存，更新时同步更新缓存

  

  

- **排行榜**：Redis Sorted Set，定时更新

  

  

- **活动信息**：Redis缓存，活动变更时更新

  

  

  

#### 5.2.4 异步处理

### 5.4 性能优化

  

  

  

#### 5.4.1 数据库优化

  

  

- **索引优化**：为常用查询字段添加索引（user_id、create_time等）

  

  

- **分表策略**：积分明细表可按时间分表（按月或按年）

  

  

- **读写分离**：查询操作走从库，写入操作走主库

  

  

  

#### 5.4.2 缓存优化

  

  

- **多级缓存**：本地缓存（Caffeine）+ Redis缓存

  

  

- **缓存更新策略**：写时更新缓存，读时先查缓存

  

  

- **缓存过期策略**：积分余额缓存设置较短过期时间（如5分钟），排行榜缓存设置较长过期时间（如1小时）

  

  

  

#### 5.4.3 异步处理

  

  

- **非关键路径异步化**：积分发放等操作异步处理

  

  

- **批量处理**：定时任务批量处理积分奖励，减少数据库压力

  

  

  

---

  

  

  

## 六、技术难点

  

  

  

### 6.1 并发安全问题

  

  

  

#### 6.1.1 问题描述

  

  

在高并发场景下，积分转让、抽奖等操作可能出现：

  

  

- 积分余额扣减重复（超卖问题）

  

  

- 抽奖奖品超发

  

  

- 积分余额不一致

  

  

  

#### 6.1.2 解决方案

  

  

1. **分布式锁**：使用Redis分布式锁保证同一用户同一时间只能有一个操作

  

  

2. **数据库事务**：使用 `@Transactional` 保证数据一致性

  

  

3. **乐观锁**：使用版本号或CAS操作更新积分余额

  

  

4. **唯一索引**：在关键字段上添加唯一索引，防止重复数据

  

  

  

**示例代码**：

  

  

```java

  

  

// 使用版本号乐观锁更新积分

  

  

UPDATE sys_user

  

  

SET points = points - #{amount}, version = version + 1

  

  

WHERE user_id = #{userId} AND version = #{version}

  

  

```

  

  

  

  

  

  

  


### 6.2 积分规则配置灵活性

  

  

  

#### 6.2.1 问题描述

  

  

不同场景需要不同的积分规则，规则配置需要灵活可扩展。

  

  

  

#### 6.2.2 解决方案

  

  

 **配置化**：通过 `sys_dict_data` 表的 `remark` 字段存储JSON配置

  

  

  

---

  

  

  

## 七、预研结果

  

  

  

### 7.1 规则校验机制预研

  

  

  

#### 7.1.1 实现内容

  

  

✅ **已实现**：基于Redis的原子性限频检查机制，支持多维限频配置。

  

  

  

#### 7.1.2 实现结果

  

  

- ✅ **已实现**：基于Redis `INCR` 和 `EXPIRE` 操作实现限频检查

  

  

- ✅ **性能**：Redis操作性能高，满足高并发场景

  

  

- ✅ **扩展性**：通过JSON配置支持多维限频（每日/每周/每月/总额度）

  

  

- ✅ **兼容性**：复用现有 `sys_dict_data` 表，通过 `remark` 字段存储JSON配置

  

  

- ✅ **功能完善**：支持限频检查和累计上限检查两种校验机制

  

  

  

#### 7.1.3 技术细节

  

  

- 使用Redis `INCR` 操作增加计数，首次设置时使用 `EXPIRE` 设置过期时间

  

  

- 支持DAILY、WEEKLY、MONTHLY、TOTAL、NONE等限频类型

  

  

- 限频Key格式：`points:limit:{changeType}:{userId}:{dateKey}`

  

  

- 累计上限Key格式：`points:maxAmount:{changeType}:{userId}`

  

  

- 配置格式：通过 `sys_dict_data.remark` 字段存储JSON配置，包含 `limitType`、`limitValue`、`maxAmount` 等字段

  

  

  

## 八、开发计划

  

  

  

### 8.1 已完成工作

  

  

#### ✅ 已完成阶段：积分系统基础优化（已完成）

  

  

**完成时间**：2025-01-XX

  

  

**目标**：完成积分系统基础功能优化和模板市场闭环

  

  

  

**已完成任务清单**：

  

  

1. **积分负数校验功能** ✅

  

  

   - 在积分扣减时实现余额校验

  

  

   - 防止积分余额出现负数

  

  

   - 扣减前检查余额是否充足

  

  

1. **积分规则限频校验功能** ✅

  

  

   - 基于Redis实现限频检查

  

  

   - 支持每日/每周/每月/总额度等多维限频

  

  

   - 支持累计上限检查

  

  

   - 通过JSON配置实现灵活配置

  

  

1. **积分规则配置优化** ✅

  

  

   - 从字典管理迁移至积分管理菜单

  

  

   - 提供专门的积分规则配置界面

  

  

   - 支持限频规则配置

  

  

1. **积分任务清单功能** ✅

  

  

   - 提供 `getPointTaskList()` 接口

  

  

   - 展示所有可获取积分的任务

  

  

   - 支持任务完成状态判断

  

  

   - 支持任务分类和图标展示

  

  

1. **我的积分总览功能** ✅

  

  

   - 提供 `getUserPointsSummary()` 接口

  

  

   - 展示积分余额、今日获得、本周获得等统计信息

  

  

   - 前端页面开发完成

  

  

1. **模板市场闭环功能** ✅

  

  

   - 我的模板箱：展示用户创建的模板和购买的模板

  

  

   - 模板市场：展示所有上架模板，支持购买、搜索、筛选

  

  

   - 模板工作坊：支持创建、编辑、上架模板

  

  

   - 模板购买功能：实现积分分配（作者收益、平台抽成）

  

  

   - 数据库表扩展：`wc_prompt_template`、`wc_call_word`、`wc_template_purchase`

  

  

1. **积分管理菜单** ✅

  

  

   - 新增"积分管理"菜单（菜单ID：2110）

  

  

   - 新增"我的积分总览"菜单（菜单ID：2111）

  

  

   - 新增"积分规则配置"菜单（菜单ID：2112）

  

  

   - 菜单权限配置完成

  

  


  

  




## 九、总结

  

  

  

本方案基于现有积分系统，通过**最小化改动**的方式实现功能扩展，主要包括：

  

  

  

### 9.1 已完成功能

  

  

1. **积分系统基础优化**：

  - ✅ 积分负数校验：防止积分余额出现负数

  - ✅ 积分规则限频校验：基于Redis实现多维限频检查

  - ✅ 积分规则配置优化：从字典管理迁移至积分管理，提供专门配置界面

  - ✅ 积分任务清单：展示所有可获取积分的任务，支持完成状态判断

  - ✅ 我的积分总览：展示积分统计信息

  

  

2. **模板市场闭环**：

  - ✅ 我的模板箱：用户管理自己创建的模板和购买的模板

  - ✅ 模板市场：展示所有上架模板，支持购买、搜索、筛选

  - ✅ 模板工作坊：支持创建、编辑、上架模板

  - ✅ 模板购买功能：实现积分分配（作者收益、平台抽成）

  

  

3. **积分管理菜单**：

  - ✅ 新增积分管理模块

  - ✅ 我的积分总览页面

  - ✅ 积分规则配置页面

  

  

### 9.2 待开发功能

  

  

1. **用户侧**：积分转让、积分抽奖等消费场景，提升积分流动性

  

  

2. **运营侧**：活动管理、数据统计、抽佣机制，增强运营能力

  

  

3. **合作伙伴侧**：模板作者等级体系和排行榜，促进生态合作

  

  

4. **系统侧**：事件驱动、异步处理、缓存优化，提升系统性能和可扩展性

  

  

  

方案采用**渐进式开发**策略，优先实现核心功能，逐步完善和优化，确保系统稳定性和可维护性。当前已完成积分系统基础优化和模板市场闭环，为后续功能扩展奠定了良好基础。