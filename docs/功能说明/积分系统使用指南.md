# ç§¯åˆ†ç³»ç»Ÿä½¿ç”¨æŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨ç§¯åˆ†ç³»ç»Ÿè¿›è¡Œç§¯åˆ†æ‰£å‡å’Œå‘æ”¾ã€‚

---

## ğŸ“‹ ç›®å½•

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [ç§¯åˆ†å‰ç½®æ ¡éªŒæœåŠ¡](#ç§¯åˆ†å‰ç½®æ ¡éªŒæœåŠ¡)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [é”™è¯¯ç è¯´æ˜](#é”™è¯¯ç è¯´æ˜)
- [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)

---

## å¿«é€Ÿå¼€å§‹

### 1. æ ¸å¿ƒæ¦‚å¿µ

ç§¯åˆ†ç³»ç»Ÿé‡‡ç”¨**å‰ç½®æ ¡éªŒ**æœºåˆ¶ï¼Œåœ¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘å‰å…ˆæ£€æŸ¥å¹¶æ‰£å‡ç§¯åˆ†ï¼Œç¡®ä¿ï¼š
- ç§¯åˆ†ä½™é¢å……è¶³
- ç¬¦åˆé™é¢‘å’Œç´¯è®¡ä¸Šé™è§„åˆ™
- äº‹åŠ¡å®‰å…¨ï¼ˆå¤±è´¥æ—¶è‡ªåŠ¨å›æ»šï¼‰

### 2. ä¾èµ–æ³¨å…¥

åœ¨éœ€è¦ä½¿ç”¨ç§¯åˆ†åŠŸèƒ½çš„ Controller æˆ– Service ä¸­æ³¨å…¥ `PointsPrecheckService`ï¼š

```java
@Autowired
private PointsPrecheckService pointsPrecheckService;
```

### 3. ç§¯åˆ†æ‰£å‡ä½¿ç”¨æ­¥éª¤

#### æ­¥éª¤1ï¼šç¡®å®šç§¯åˆ†è§„åˆ™ç¼–ç 

é¦–å…ˆï¼Œéœ€è¦ç¡®å®šä¸šåŠ¡å¯¹åº”çš„ç§¯åˆ†è§„åˆ™ç¼–ç ã€‚å¯ä»¥åœ¨æ•°æ®åº“ `wx_points_rule` è¡¨ä¸­æŸ¥è¯¢ï¼Œæˆ–å‚è€ƒæœ¬æ–‡æ¡£[å¸¸è§è§„åˆ™ç¼–ç ](#å¸¸è§è§„åˆ™ç¼–ç )éƒ¨åˆ†ã€‚

**ç§¯åˆ†æ‰£å‡è§„åˆ™ç¤ºä¾‹**ï¼š
- `USE_DAILY_ASSISTANT`ï¼šä½¿ç”¨æ—¥æ›´åŠ©æ‰‹ï¼ˆæ‰£1ç§¯åˆ†ï¼‰
- `ARTICLE_LAYOUT`ï¼šæ™ºèƒ½æ’ç‰ˆï¼ˆæ‰£1ç§¯åˆ†ï¼‰
- `TEMPLATE_BUY`ï¼šæ¨¡æ¿è´­ä¹°

#### æ­¥éª¤2ï¼šè·å–å½“å‰ç”¨æˆ·ID

é€šå¸¸ä»è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­è·å–å½“å‰ç™»å½•ç”¨æˆ·IDï¼š

```java
Long userId = getUserId(); // ä»BaseControllerç»§æ‰¿çš„æ–¹æ³•
```

#### æ­¥éª¤3ï¼šè°ƒç”¨ç§¯åˆ†å‰ç½®æ ¡éªŒæœåŠ¡

åœ¨ä¸šåŠ¡é€»è¾‘æ‰§è¡Œ**ä¹‹å‰**è°ƒç”¨ç§¯åˆ†å‰ç½®æ ¡éªŒæœåŠ¡ï¼š

```java
// å‚æ•°è¯´æ˜ï¼šç”¨æˆ·IDã€è§„åˆ™ç¼–ç ã€è‡ªå®šä¹‰ç§¯åˆ†å€¼ï¼ˆnullåˆ™ä½¿ç”¨è§„åˆ™é»˜è®¤å€¼ï¼‰
PointsResult pointsResult = pointsPrecheckService.tryChangePoints(userId, "ARTICLE_LAYOUT", null);
```

#### æ­¥éª¤4ï¼šå¤„ç†æ ¡éªŒç»“æœ

æ£€æŸ¥ç§¯åˆ†æ ¡éªŒç»“æœï¼Œå¦‚æœå¤±è´¥åˆ™ç›´æ¥è¿”å›é”™è¯¯ï¼š

```java
if (!pointsResult.isSuccess()) {
    // ç§¯åˆ†ä¸è¶³æˆ–è§„åˆ™æ ¡éªŒå¤±è´¥ï¼Œç›´æ¥æ‹¦æˆªï¼Œä¸æ‰§è¡Œåç»­ä¸šåŠ¡
    return AjaxResult.error(pointsResult.getMsg());
}
// ç§¯åˆ†æ ¡éªŒé€šè¿‡ï¼Œç»§ç»­æ‰§è¡Œä¸šåŠ¡é€»è¾‘
```

#### æ­¥éª¤5ï¼šä¸šåŠ¡å®Œæˆåè¿”å›ç»“æœï¼ˆå¯é€‰ï¼‰

å¯ä»¥å°†æ‰£å‡åçš„ç§¯åˆ†ä½™é¢è¿”å›ç»™å‰ç«¯ï¼Œæ–¹ä¾¿ç”¨æˆ·äº†è§£å½“å‰ç§¯åˆ†æƒ…å†µï¼š

```java
// è¿”å›ç»“æœä¸­åŒ…å«æ‰£å‡åçš„ç§¯åˆ†ä½™é¢
Map<String, Object> result = new HashMap<>();
result.put("businessData", businessResult);
result.put("pointsBalance", pointsResult.getBalanceAfter()); // æ‰£å‡åçš„ç§¯åˆ†ä½™é¢
return AjaxResult.success(result);
```

### 4. å®Œæ•´ç§¯åˆ†æ‰£å‡ç¤ºä¾‹ï¼ˆæ™ºèƒ½æ’ç‰ˆåŠŸèƒ½ï¼‰

```java
@PostMapping("/layoutArticle")
public AjaxResult layoutArticle(@RequestBody Map<String, Object> params) {
    try {
        // 1. è·å–è¯·æ±‚å‚æ•°
        String content = params.get("content").toString();
        if (StringUtils.isEmpty(content)) {
            return AjaxResult.error("æ’ç‰ˆå†…å®¹ä¸èƒ½ä¸ºç©º");
        }

        // 2. è·å–å½“å‰ç”¨æˆ·ID
        Long userId = getUserId();
        
        // 3. ç§¯åˆ†å‰ç½®æ ¡éªŒï¼šæ™ºèƒ½æ’ç‰ˆæ‰£å‡1ç§¯åˆ†
        PointsResult pointsResult = pointsPrecheckService.tryChangePoints(
            userId, 
            "ARTICLE_LAYOUT",  // æ™ºèƒ½æ’ç‰ˆè§„åˆ™ç¼–ç 
            null                // ä½¿ç”¨è§„åˆ™é»˜è®¤ç§¯åˆ†å€¼ï¼ˆ-1ï¼‰
        );

        if (!pointsResult.isSuccess()) {
            // ç§¯åˆ†ä¸è¶³æˆ–è§„åˆ™æ ¡éªŒå¤±è´¥ï¼Œç›´æ¥æ‹¦æˆª
            return AjaxResult.error(pointsResult.getMsg());
        }
        // ========== ç§¯åˆ†æ ¡éªŒé€šè¿‡ï¼Œç»§ç»­æ‰§è¡Œä¸šåŠ¡ ==========

        // 4. æ‰§è¡Œæ™ºèƒ½æ’ç‰ˆä¸šåŠ¡é€»è¾‘
        String layoutedContent = dailyArticleService.layoutArticleSync(userId, content);

        // 5. è¿”å›ç»“æœï¼ŒåŒ…å«æ’ç‰ˆå†…å®¹å’Œæ‰£å‡åçš„ç§¯åˆ†ä½™é¢
        Map<String, Object> result = new HashMap<>();
        result.put("layoutedContent", layoutedContent);
        result.put("message", "æ’ç‰ˆå®Œæˆ");
        result.put("pointsBalance", pointsResult.getBalanceAfter()); // æ‰£å‡åçš„ç§¯åˆ†ä½™é¢

        return AjaxResult.success(result);

    } catch (Exception e) {
        log.error("æ’ç‰ˆå¤±è´¥: {}", e.getMessage());
        return AjaxResult.error("æ’ç‰ˆå¤±è´¥ï¼š" + e.getMessage());
    }
}
```

---

## ç§¯åˆ†å‰ç½®æ ¡éªŒæœåŠ¡

### PointsPrecheckService

**æ ¸å¿ƒæ–¹æ³•**ï¼š`tryChangePoints(Long userId, String ruleCode, Integer changeAmount)`

**å‚æ•°è¯´æ˜**ï¼š
- `userId`ï¼šç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
- `ruleCode`ï¼šè§„åˆ™ç¼–ç ï¼ˆå¿…å¡«ï¼‰ï¼Œä½¿ç”¨æšä¸¾ `PointsRuleCode` ä¸­çš„ç¼–ç 
- `changeAmount`ï¼šç§¯åˆ†å˜åŠ¨å€¼ï¼ˆå¯é€‰ï¼‰ï¼Œä¸ä¼ åˆ™ä½¿ç”¨è§„åˆ™é»˜è®¤å€¼

**è¿”å›å€¼**ï¼š`PointsResult`
- `isSuccess()`ï¼šæ˜¯å¦æˆåŠŸ
- `getCode()`ï¼šé”™è¯¯ç ï¼ˆå¤±è´¥æ—¶ï¼‰
- `getMsg()`ï¼šé”™è¯¯æ¶ˆæ¯ï¼ˆå¤±è´¥æ—¶ï¼‰
- `getDelta()`ï¼šç§¯åˆ†å˜åŠ¨å€¼ï¼ˆæˆåŠŸæ—¶ï¼‰
- `getBalanceAfter()`ï¼šå˜åŠ¨åä½™é¢ï¼ˆæˆåŠŸæ—¶ï¼‰

---

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæ—¥æ›´åŠ©æ‰‹æ–‡ç« ç”Ÿæˆï¼ˆæ‰£å‡ç§¯åˆ†ï¼‰

```java
@PostMapping("/createAndOptimize")
public AjaxResult createAndOptimize(@RequestBody Map<String, String> params) {
    Long userId = getUserId();
    
    // ç§¯åˆ†å‰ç½®æ ¡éªŒï¼šä½¿ç”¨æ—¥æ›´åŠ©æ‰‹è§„åˆ™ç¼–ç 
    PointsResult pointsResult = pointsPrecheckService.tryChangePoints(
        userId, 
        PointsRuleCode.USE_DAILY_ASSISTANT.getCode(), 
        null
    );
    
    if (!pointsResult.isSuccess()) {
        // ç§¯åˆ†ä¸è¶³æˆ–è§„åˆ™æ ¡éªŒå¤±è´¥ï¼Œç›´æ¥æ‹¦æˆª
        return AjaxResult.error(pointsResult.getMsg());
    }
    
    // ç§¯åˆ†æ ¡éªŒé€šè¿‡ï¼Œç»§ç»­æ‰§è¡Œä¸šåŠ¡
    DailyArticle article = dailyArticleService.createArticleAndOptimize(
        userId, 
        articleTitle, 
        selectedModels
    );
    
    // è¿”å›ç»“æœï¼ŒåŒ…å«æ‰£å‡åçš„ç§¯åˆ†ä½™é¢
    Map<String, Object> result = new HashMap<>();
    result.put("id", article.getId());
    result.put("pointsBalance", pointsResult.getBalanceAfter());
    
    return AjaxResult.success(result);
}
```

### ç¤ºä¾‹2ï¼šæ¯æ—¥ç™»å½•å¥–åŠ±ï¼ˆå¢åŠ ç§¯åˆ†ï¼‰

```java
@PostMapping("/dailyLogin")
public AjaxResult dailyLogin() {
    Long userId = getUserId();
    
    // ç§¯åˆ†å‰ç½®æ ¡éªŒï¼šä½¿ç”¨æ¯æ—¥ç™»å½•è§„åˆ™ç¼–ç 
    PointsResult pointsResult = pointsPrecheckService.tryChangePoints(
        userId, 
        PointsRuleCode.DAILY_LOGIN.getCode(), 
        null
    );
    
    if (!pointsResult.isSuccess()) {
        return AjaxResult.error(pointsResult.getMsg());
    }
    
    // ç™»å½•å¥–åŠ±å‘æ”¾æˆåŠŸ
    return AjaxResult.success("ç™»å½•å¥–åŠ±å·²å‘æ”¾ï¼Œè·å¾— " + pointsResult.getDelta() + " ç§¯åˆ†");
}
```

### ç¤ºä¾‹3ï¼šè‡ªå®šä¹‰ç§¯åˆ†å€¼

```java
// å¦‚æœéœ€è¦åœ¨è§„åˆ™é»˜è®¤å€¼åŸºç¡€ä¸Šè‡ªå®šä¹‰ç§¯åˆ†å€¼
PointsResult pointsResult = pointsPrecheckService.tryChangePoints(
    userId, 
    "USE_DAILY_ASSISTANT", 
    -5  // è‡ªå®šä¹‰æ‰£å‡5ç§¯åˆ†
);
```

---

## é”™è¯¯ç è¯´æ˜

| é”™è¯¯ç  | è¯´æ˜ | å¤„ç†å»ºè®® |
|--------|------|---------|
| `USER_EMPTY` | ç”¨æˆ·IDä¸ºç©º | æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€ |
| `USER_NOT_FOUND` | ç”¨æˆ·ä¸å­˜åœ¨ | æ£€æŸ¥ç”¨æˆ·IDæ˜¯å¦æ­£ç¡® |
| `USER_DISABLED` | ç”¨æˆ·ä¸å¯ç”¨ | è”ç³»ç®¡ç†å‘˜å¯ç”¨ç”¨æˆ· |
| `RULE_EMPTY` | è§„åˆ™ç¼–ç ä¸ºç©º | æ£€æŸ¥è§„åˆ™ç¼–ç å‚æ•° |
| `RULE_NOT_FOUND` | ç§¯åˆ†è§„åˆ™ä¸å­˜åœ¨ | æ£€æŸ¥è§„åˆ™ç¼–ç æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜é…ç½®è§„åˆ™ |
| `RULE_DISABLED` | ç§¯åˆ†è§„åˆ™å·²åœç”¨ | è”ç³»ç®¡ç†å‘˜å¯ç”¨è§„åˆ™ |
| `POINTS_ZERO` | ç§¯åˆ†å˜åŠ¨å€¼æ— æ•ˆ | æ£€æŸ¥è§„åˆ™é…ç½® |
| `LIMIT_REACHED` | å·²è¾¾åˆ°é™é¢‘ä¸Šé™ | æç¤ºç”¨æˆ·ç¨åå†è¯• |
| `MAX_AMOUNT_REACHED` | å·²è¾¾åˆ°ç´¯è®¡ä¸Šé™ | æç¤ºç”¨æˆ·å·²è¾¾åˆ°ä¸Šé™ |
| `INSUFFICIENT_BALANCE` | ç§¯åˆ†ä½™é¢ä¸è¶³ | æç¤ºç”¨æˆ·å……å€¼æˆ–è·å–ç§¯åˆ† |
| `POINTS_ERROR` | ç§¯åˆ†å¤„ç†å¤±è´¥ | è®°å½•æ—¥å¿—ï¼Œè”ç³»æŠ€æœ¯æ”¯æŒ |

---

## æ³¨æ„äº‹é¡¹

### 1. è§„åˆ™ç¼–ç ä½¿ç”¨

- âœ… **æ­£ç¡®**ï¼šä½¿ç”¨æšä¸¾ `PointsRuleCode.USE_DAILY_ASSISTANT.getCode()`
- âœ… **æ­£ç¡®**ï¼šç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸² `"USE_DAILY_ASSISTANT"`
- âŒ **é”™è¯¯**ï¼šä½¿ç”¨è§„åˆ™åç§° `"ä½¿ç”¨æ—¥æ›´åŠ©æ‰‹"`

### 2. ä¸šåŠ¡æ‰§è¡Œé¡ºåº

**å¿…é¡»**åœ¨ä¸šåŠ¡é€»è¾‘æ‰§è¡Œå‰è¿›è¡Œç§¯åˆ†æ ¡éªŒï¼š

```java
// âœ… æ­£ç¡®ï¼šå…ˆæ ¡éªŒç§¯åˆ†ï¼Œå†æ‰§è¡Œä¸šåŠ¡
PointsResult result = pointsPrecheckService.tryChangePoints(userId, ruleCode, null);
if (!result.isSuccess()) {
    return AjaxResult.error(result.getMsg());
}
// æ‰§è¡Œä¸šåŠ¡é€»è¾‘
doBusiness();

// âŒ é”™è¯¯ï¼šå…ˆæ‰§è¡Œä¸šåŠ¡ï¼Œå†æ ¡éªŒç§¯åˆ†
doBusiness();
PointsResult result = pointsPrecheckService.tryChangePoints(userId, ruleCode, null);
```

### 3. äº‹åŠ¡å¤„ç†

ç§¯åˆ†å‰ç½®æ ¡éªŒæœåŠ¡å†…éƒ¨å·²åŒ…å«äº‹åŠ¡å¤„ç†ï¼Œæ— éœ€åœ¨ä¸šåŠ¡å±‚å†æ¬¡æ·»åŠ äº‹åŠ¡æ³¨è§£ã€‚

### 4. å¼‚å¸¸å¤„ç†

ç§¯åˆ†å‰ç½®æ ¡éªŒæœåŠ¡å·²ç»Ÿä¸€å°è£…æ‰€æœ‰å¼‚å¸¸æƒ…å†µï¼Œä¸šåŠ¡æ–¹åªéœ€æ£€æŸ¥ `isSuccess()` å³å¯ã€‚

---

## å¸¸è§è§„åˆ™ç¼–ç 

| è§„åˆ™ç¼–ç  | è¯´æ˜ | ç§¯åˆ†å€¼ |
|---------|------|--------|
| `USE_DAILY_ASSISTANT` | ä½¿ç”¨æ—¥æ›´åŠ©æ‰‹ | -1 |
| `ARTICLE_LAYOUT` | æ™ºèƒ½æ’ç‰ˆ | -1 |
| `DAILY_LOGIN` | æ¯æ—¥ç™»å½• | +10 |
| `TEMPLATE_PUBLISH` | æ¨¡æ¿ä¸Šæ¶ | +50 |
| `TEMPLATE_BUY` | æ¨¡æ¿è´­ä¹° | -10 |
| `TEMPLATE_REWARD` | æ¨¡æ¿åˆ†æˆ | +8 |
| `RECHARGE` | å……å€¼èµ é€ | +100 |
| `ADMIN_GRANT` | ç®¡ç†å‘˜å‘æ”¾ | è‡ªå®šä¹‰ |

---

## æƒé™ç®¡ç†

### åŠŸèƒ½èœå•æƒé™

ç§¯åˆ†ç³»ç»ŸåŒ…å«ä»¥ä¸‹åŠŸèƒ½èœå•åŠå…¶æƒé™é…ç½®ï¼š

| èœå•åç§° | èœå•ID | æƒé™æ ‡è¯† | è¯´æ˜ |
|---------|-------|---------|------|
| ç§¯åˆ†ç®¡ç† | 6 | - | ä¸€çº§èœå• |
| ç§¯åˆ†æ€»è§ˆ | 120 | business:points:view | ç§¯åˆ†æ€»è§ˆé¡µé¢ |
| ç§¯åˆ†è§„åˆ™é…ç½® | 121 | points:rule:list | ç§¯åˆ†è§„åˆ™é…ç½®é¡µé¢ |
| ç²‰ä¸ç®¡ç† | 122 | points:fans:list | ç²‰ä¸ç®¡ç†é¡µé¢ |

### æŒ‰é’®æƒé™

| æŒ‰é’®åç§° | æŒ‰é’®ID | æ‰€å±èœå• | æƒé™æ ‡è¯† | è¯´æ˜ |
|---------|-------|---------|---------|------|
| ç§¯åˆ†æŸ¥è¯¢ | 1070 | ç§¯åˆ†æ€»è§ˆ | business:points:query | æŸ¥è¯¢ç”¨æˆ·ç§¯åˆ†ä½™é¢ |
| æ˜ç»†æŸ¥è¯¢ | 1071 | ç§¯åˆ†æ€»è§ˆ | business:points:record:query | æŸ¥è¯¢ç§¯åˆ†å˜åŠ¨æ˜ç»† |
| è§„åˆ™æŸ¥è¯¢ | 1072 | ç§¯åˆ†è§„åˆ™é…ç½® | points:rule:query | æŸ¥è¯¢ç§¯åˆ†è§„åˆ™ |
| è§„åˆ™æ–°å¢ | 1073 | ç§¯åˆ†è§„åˆ™é…ç½® | points:rule:add | æ–°å¢ç§¯åˆ†è§„åˆ™ |
| è§„åˆ™ä¿®æ”¹ | 1074 | ç§¯åˆ†è§„åˆ™é…ç½® | points:rule:edit | ä¿®æ”¹ç§¯åˆ†è§„åˆ™ |
| è§„åˆ™åˆ é™¤ | 1075 | ç§¯åˆ†è§„åˆ™é…ç½® | points:rule:remove | åˆ é™¤ç§¯åˆ†è§„åˆ™ |
| ç²‰ä¸åˆ—è¡¨ | 1076 | ç²‰ä¸ç®¡ç† | points:fans:list | æŸ¥çœ‹ç²‰ä¸åˆ—è¡¨ |
| å‘æ”¾ç§¯åˆ† | 1077 | ç²‰ä¸ç®¡ç† | points:fans:grant | ç»™ç”¨æˆ·å‘æ”¾ç§¯åˆ† |
| æŸ¥çœ‹æ˜ç»† | 1078 | ç²‰ä¸ç®¡ç† | points:fans:detail | æŸ¥çœ‹ç”¨æˆ·ç§¯åˆ†æ˜ç»† |

### è§’è‰²æƒé™åˆ†é…

| è§’è‰²ID | è§’è‰²æƒé™è¯´æ˜ |
|-------|------------|
| 2 | æ‹¥æœ‰ç§¯åˆ†ç®¡ç†çš„å…¨éƒ¨æƒé™ï¼ˆåŒ…æ‹¬èœå•å’Œæ‰€æœ‰æŒ‰é’®æƒé™ï¼Œæ–°å¢ç²‰ä¸ç®¡ç†çš„å…¨éƒ¨æƒé™ï¼‰ |
| 3 | æ‹¥æœ‰ç§¯åˆ†ç®¡ç†èœå•çš„åªè¯»è®¿é—®æƒé™ |
| 10 | æ™®é€šç”¨æˆ·è§’è‰²ï¼Œæ‹¥æœ‰ç§¯åˆ†æŸ¥è¯¢ã€æ˜ç»†æŸ¥è¯¢ã€è§„åˆ™æŸ¥è¯¢ã€ç²‰ä¸åˆ—è¡¨å’ŒæŸ¥çœ‹æ˜ç»†æƒé™ |

---

**æœ€åæ›´æ–°**: 2025-12-10  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.1.0

