# ğŸ“® å…¬ä¼—å·è‰ç¨¿ä¸Šä¼ åŠŸèƒ½è¯´æ˜

æœ¬æ–‡æ¡£ä»‹ç»å¾®ä¿¡å…¬ä¼—å·è‰ç¨¿ä¸Šä¼ åŠŸèƒ½çš„æŠ€æœ¯å®ç°ï¼Œä¾›å¼€å‘äººå‘˜å¿«é€Ÿäº†è§£åŠŸèƒ½æ¶æ„å’Œä»£ç ç»“æ„ã€‚

---

## ğŸ“‹ ç›®å½•

- [åŠŸèƒ½æ¦‚è¿°](#-åŠŸèƒ½æ¦‚è¿°)
- [æ•°æ®åº“è®¾è®¡](#-æ•°æ®åº“è®¾è®¡)
- [æŠ€æœ¯å®ç°](#-æŠ€æœ¯å®ç°)
  - [å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½](#-å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½)
  - [è‰ç¨¿æŠ•é€’åŠŸèƒ½](#-è‰ç¨¿æŠ•é€’åŠŸèƒ½)
- [ä»£ç æ–‡ä»¶ç»“æ„](#-ä»£ç æ–‡ä»¶ç»“æ„)

---

## ğŸ“– åŠŸèƒ½æ¦‚è¿°

å°†æ—¥æ›´åŠ©æ‰‹ç”Ÿæˆçš„æ–‡ç« è‡ªåŠ¨æŠ•é€’åˆ°å¾®ä¿¡å…¬ä¼—å·è‰ç¨¿ç®±ï¼ŒåŒ…å«ä»¥ä¸‹åŠŸèƒ½ï¼š

- **å…¬ä¼—å·é…ç½®ç®¡ç†** - AppID/AppSecretåŠ å¯†å­˜å‚¨
- **å›¾ç‰‡ä¸Šä¼ ** - æŒ‰ç”¨æˆ·éš”ç¦»çš„ç´ æå›¾ç‰‡ç®¡ç†
- **æ–‡ç« æŠ•é€’** - æ”¯æŒå¤šç§å†…å®¹ç±»å‹æŠ•é€’
- **å‘å¸ƒè®°å½•** - å®Œæ•´çš„å‘å¸ƒå†å²è®°å½•

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. å…¬ä¼—å·é…ç½®è¡¨ (wc_office_account)

**è¡¨ä½ç½®ï¼š** `sql/updates/update_20251208_wc_office_account.sql`

å­˜å‚¨ç”¨æˆ·çš„å¾®ä¿¡å…¬ä¼—å·é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¼€å‘è€…IDå’Œå¯†é’¥ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰ã€‚

**ä¸»è¦å­—æ®µï¼š**

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `id` | BIGINT | é…ç½®IDï¼ˆä¸»é”®ï¼‰ |
| `user_id` | BIGINT | ç”¨æˆ·IDï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰ |
| `app_id` | VARCHAR(255) | å¼€å‘è€…IDï¼ˆAESåŠ å¯†ï¼‰ |
| `app_secret` | VARCHAR(255) | å¼€å‘è€…å¯†é’¥ï¼ˆAESåŠ å¯†ï¼‰ |
| `office_account_name` | VARCHAR(100) | å…¬ä¼—å·åç§° |
| `author_name` | VARCHAR(50) | ä½œè€…åç§° |
| `pic_url` | VARCHAR(500) | ç´ æå°é¢å›¾URL |
| `media_id` | VARCHAR(100) | å¾®ä¿¡ç´ æID |
| `is_active` | TINYINT | æ˜¯å¦å¯ç”¨ï¼ˆ0-ç¦ç”¨ï¼Œ1-å¯ç”¨ï¼‰ |
| `create_time` | DATETIME | åˆ›å»ºæ—¶é—´ |
| `update_time` | DATETIME | æ›´æ–°æ—¶é—´ |

**ç‰¹ç‚¹ï¼š**
- æ¯ä¸ªç”¨æˆ·åªèƒ½é…ç½®ä¸€ä¸ªå…¬ä¼—å·ï¼ˆé€šè¿‡`user_id`å”¯ä¸€ç´¢å¼•çº¦æŸï¼‰
- AppIDå’ŒAppSecretä½¿ç”¨AES-256-GCMåŠ å¯†å­˜å‚¨
- æ”¯æŒå¯ç”¨/ç¦ç”¨çŠ¶æ€

**Mapperä½ç½®ï¼š**
- Javaæ¥å£ï¼š`WcOfficeAccountMapper.java`
- XMLæ˜ å°„ï¼š`WcOfficeAccountMapper.xml`

---

### 2. å‘å¸ƒè®°å½•è¡¨ (wc_office_publish_record)

è®°å½•æ¯æ¬¡æ–‡ç« å‘å¸ƒåˆ°å…¬ä¼—å·çš„è¯¦ç»†ä¿¡æ¯ã€‚

**ä¸»è¦å­—æ®µï¼š**

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `id` | BIGINT | è®°å½•IDï¼ˆä¸»é”®ï¼‰ |
| `user_id` | BIGINT | ç”¨æˆ·ID |
| `article_id` | BIGINT | å…³è”çš„æ—¥æ›´åŠ©æ‰‹æ–‡ç« ID |
| `office_account_id` | BIGINT | å…¬ä¼—å·é…ç½®ID |
| `article_title` | VARCHAR(200) | æ–‡ç« æ ‡é¢˜ |
| `content_type` | VARCHAR(20) | å‘å¸ƒçš„å†…å®¹ç±»å‹ |
| `publish_status` | TINYINT | å‘å¸ƒçŠ¶æ€ï¼ˆ0-å‘å¸ƒä¸­ï¼Œ1-æˆåŠŸï¼Œ2-å¤±è´¥ï¼‰ |
| `media_id` | VARCHAR(100) | å¾®ä¿¡ç´ æID |
| `error_message` | TEXT | å¤±è´¥åŸå›  |
| `publish_time` | DATETIME | å‘å¸ƒæ—¶é—´ |
| `create_time` | DATETIME | åˆ›å»ºæ—¶é—´ |

**å†…å®¹ç±»å‹(content_type)ï¼š**
- `optimized` - ä¼˜åŒ–åå†…å®¹
- `model1` - æ¨¡å‹1ç”Ÿæˆå†…å®¹
- `model2` - æ¨¡å‹2ç”Ÿæˆå†…å®¹
- `model3` - æ¨¡å‹3ç”Ÿæˆå†…å®¹
- `layout` - æ’ç‰ˆåå†…å®¹

**ç‰¹ç‚¹ï¼š**
- å®Œæ•´è®°å½•æ¯æ¬¡å‘å¸ƒæ“ä½œ
- æ”¯æŒå¤±è´¥åŸå› è®°å½•ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
- é€šè¿‡`article_id`å…³è”æ—¥æ›´åŠ©æ‰‹æ–‡ç« 
- è®°å½•å¾®ä¿¡è¿”å›çš„`media_id`ï¼Œä¾¿äºåç»­æ“ä½œ

**Mapperä½ç½®ï¼š**
- Javaæ¥å£ï¼š`WcOfficePublishRecordMapper.java`
- XMLæ˜ å°„ï¼š`WcOfficePublishRecordMapper.xml`

---

## ğŸ“¸ å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½

### æ–‡ä»¶è·¯å¾„è®¾è®¡

#### è·¯å¾„ç»“æ„

```
./WxFbsir/uploadPath/upload/officialaccount/
â””â”€â”€ {userId}/
    â”œâ”€â”€ cover.jpg
    â”œâ”€â”€ logo.png
    â”œâ”€â”€ banner(1).jpg    # æ–‡ä»¶åé‡å¤ï¼Œè‡ªåŠ¨æ·»åŠ åºå·
    â”œâ”€â”€ banner(2).jpg
    â””â”€â”€ article-pic.jpg
```

#### URLæ ¼å¼

**åŸºç¡€æ ¼å¼ï¼š**
```
http://localhost:8080/profile/upload/officialaccount/{userId}/{filename}
```

**å®é™…ç¤ºä¾‹ï¼š**
```
ç”¨æˆ·ID: 1
æ–‡ä»¶å: cover.jpg
å®Œæ•´URL: http://localhost:8080/profile/upload/officialaccount/1/cover.jpg

ç”¨æˆ·ID: 2  
æ–‡ä»¶å: banner.jpg (é‡å¤)
ç¬¬ä¸€æ¬¡: http://localhost:8080/profile/upload/officialaccount/2/banner.jpg
ç¬¬äºŒæ¬¡: http://localhost:8080/profile/upload/officialaccount/2/banner(1).jpg
ç¬¬ä¸‰æ¬¡: http://localhost:8080/profile/upload/officialaccount/2/banner(2).jpg
```

---

### å›¾ç‰‡ä¸Šä¼ æ ¸å¿ƒç‰¹æ€§

#### 1. ç”¨æˆ·éš”ç¦»
- âœ… æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ç›®å½•
- âœ… ä¸åŒç”¨æˆ·æ–‡ä»¶äº’ä¸å½±å“
- âœ… ä¾¿äºæŒ‰ç”¨æˆ·ç®¡ç†å’Œæ¸…ç†

#### 2. æ–‡ä»¶åå¤„ç†
- âœ… ä¿ç•™åŸå§‹æ–‡ä»¶å
- âœ… è‡ªåŠ¨æ£€æµ‹é‡å¤
- âœ… é‡å¤æ—¶æ·»åŠ åºå·ï¼š`filename(1).ext`

#### 3. å®Œæ•´URL
- âœ… ä¸Šä¼ å³è¿”å›å®Œæ•´URL
- âœ… åŒ…å«åŸŸåã€è·¯å¾„ã€ç”¨æˆ·IDã€æ–‡ä»¶å
- âœ… ç›´æ¥å­˜å‚¨å’Œä½¿ç”¨

---

### å›¾ç‰‡ä¸Šä¼ åç«¯å®ç°

**ä»£ç ä½ç½®ï¼š** `WxFbsir-common/src/main/java/com/wx/fbsir/common/utils/file/FileUploadUtils.java`

#### 1. æ–‡ä»¶åç”Ÿæˆæ–¹æ³•

```java
/**
 * å…¬ä¼—å·ä¸“ç”¨æ–‡ä»¶å(ç”¨æˆ·IDç›®å½• + åŸæ–‡ä»¶å + åç¼€)
 * å¦‚æœæ–‡ä»¶åé‡å¤ï¼Œè‡ªåŠ¨æ·»åŠ åºå·
 */
public static String officialAccountFilename(MultipartFile file, Long userId, String baseDir) {
    String originalFilename = file.getOriginalFilename();
    String baseName = FilenameUtils.getBaseName(originalFilename);
    String extension = getExtension(file);
    
    // æ„å»ºç”¨æˆ·ç›®å½•è·¯å¾„
    String userDir = String.valueOf(userId);
    String fileName = StringUtils.format("{}.{}", baseName, extension);
    
    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™æ·»åŠ åºå·
    File targetFile = new File(baseDir + File.separator + userDir + File.separator + fileName);
    int counter = 1;
    while (targetFile.exists()) {
        fileName = StringUtils.format("{}({}).{}", baseName, counter, extension);
        targetFile = new File(baseDir + File.separator + userDir + File.separator + fileName);
        counter++;
    }
    
    return StringUtils.format("{}/{}", userDir, fileName);
}
```

#### 2. ä¸Šä¼ æ–¹æ³•

```java
/**
 * å…¬ä¼—å·ä¸“ç”¨ä¸Šä¼ æ–¹æ³•å¹¶è¿”å›å®Œæ•´URL
 * ä½¿ç”¨ç”¨æˆ·IDä½œä¸ºç›®å½•ï¼Œæ–‡ä»¶åé‡å¤æ—¶è‡ªåŠ¨æ·»åŠ åºå·
 */
public static String uploadOfficialAccountAndGetFullUrl(
    String baseDir, 
    MultipartFile file, 
    Long userId, 
    String[] allowedExtension
) throws FileSizeLimitExceededException, IOException, 
         FileNameLengthLimitExceededException, InvalidExtensionException {
    
    // æ–‡ä»¶åé•¿åº¦éªŒè¯
    int fileNameLength = Objects.requireNonNull(file.getOriginalFilename()).length();
    if (fileNameLength > FileUploadUtils.DEFAULT_FILE_NAME_LENGTH) {
        throw new FileNameLengthLimitExceededException(FileUploadUtils.DEFAULT_FILE_NAME_LENGTH);
    }

    // æ–‡ä»¶ç±»å‹å’Œå¤§å°éªŒè¯
    assertAllowed(file, allowedExtension);

    // ä½¿ç”¨å…¬ä¼—å·ä¸“ç”¨çš„æ–‡ä»¶åç”Ÿæˆæ–¹æ³•
    String fileName = officialAccountFilename(file, userId, baseDir);

    // ä¿å­˜æ–‡ä»¶
    String absPath = getAbsoluteFile(baseDir, fileName).getAbsolutePath();
    file.transferTo(Paths.get(absPath));
    
    // è¿”å›å®Œæ•´URL
    return getFullUrl(baseDir, fileName);
}
```

#### 3. ä¸Šä¼ æ¥å£

**ä»£ç ä½ç½®ï¼š** `WxFbsir-admin/src/main/java/com/wx/fbsir/web/controller/common/CommonController.java`

```java
/**
 * å…¬ä¼—å·å›¾ç‰‡ä¸Šä¼ è¯·æ±‚
 * ä¸Šä¼ åˆ° officialaccount/{userId} ç›®å½•ï¼Œå¹¶è¿”å›å®Œæ•´URL
 * æ–‡ä»¶åé‡å¤æ—¶è‡ªåŠ¨æ·»åŠ åºå·
 */
@PostMapping("/upload/officialaccount")
public AjaxResult uploadOfficialAccountImage(MultipartFile file) throws Exception {
    try {
        // è·å–å½“å‰ç”¨æˆ·ID
        Long userId = getUserId();
        
        // å…¬ä¼—å·å›¾ç‰‡ä¸Šä¼ è·¯å¾„
        String filePath = WxFbsirConfig.getOfficialAccountUploadPath();
        
        // ä½¿ç”¨å…¬ä¼—å·ä¸“ç”¨ä¸Šä¼ æ–¹æ³•
        String fullUrl = FileUploadUtils.uploadOfficialAccountAndGetFullUrl(
            filePath, 
            file, 
            userId, 
            MimeTypeUtils.IMAGE_EXTENSION
        );
        
        AjaxResult ajax = AjaxResult.success();
        ajax.put("url", fullUrl);
        ajax.put("fileName", fullUrl);
        ajax.put("newFileName", FileUtils.getName(fullUrl));
        ajax.put("originalFilename", file.getOriginalFilename());
        return ajax;
    } catch (Exception e) {
        return AjaxResult.error(e.getMessage());
    }
}
```

---

### å›¾ç‰‡ä¸Šä¼ å‰ç«¯ä½¿ç”¨

**ä»£ç ä½ç½®ï¼š** `WxFbsir-ui/src/views/system/user/profile/officeAccountConfig.vue`

```vue
<template>
  <el-form-item label="ç´ æå°é¢å›¾" prop="picUrl">
    <image-upload 
      v-model="form.picUrl" 
      :limit="1"
      action="/common/upload/officialaccount"
    />
  </el-form-item>
</template>

<script setup>
const form = ref({
  picUrl: ""  // å­˜å‚¨å®Œæ•´URL
})

// æäº¤è¡¨å•
async function submitForm() {
  // form.picUrl å·²ç»æ˜¯å®Œæ•´URL
  // ä¾‹å¦‚: http://localhost:8080/profile/upload/officialaccount/1/cover.jpg
  await saveConfig(form)
}
</script>
```

---

## ğŸ“® è‰ç¨¿æŠ•é€’åŠŸèƒ½

### è‰ç¨¿æŠ•é€’åç«¯å®ç°

#### 1. æ ¸å¿ƒæ–‡ä»¶ç»“æ„

```
WxFbsir-business/src/main/java/com/wx/fbsir/business/officialaccount/
â”œâ”€â”€ controller/
â”‚   â””â”€â”€ WcOfficeAccountController.java         # æ§åˆ¶å™¨
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ WcOfficeAccount.java                   # å…¬ä¼—å·é…ç½®å®ä½“
â”‚   â””â”€â”€ WcOfficePublishRecord.java             # å‘å¸ƒè®°å½•å®ä½“
â”œâ”€â”€ mapper/
â”‚   â”œâ”€â”€ WcOfficeAccountMapper.java             # å…¬ä¼—å·é…ç½®Mapper
â”‚   â””â”€â”€ WcOfficePublishRecordMapper.java       # å‘å¸ƒè®°å½•Mapper
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ IWcOfficeAccountService.java           # å…¬ä¼—å·é…ç½®Serviceæ¥å£
â”‚   â”œâ”€â”€ IWcOfficePublishRecordService.java     # å‘å¸ƒè®°å½•Serviceæ¥å£
â”‚   â”œâ”€â”€ WechatOfficialApiService.java          # å¾®ä¿¡APIæœåŠ¡
â”‚   â””â”€â”€ impl/
â”‚       â”œâ”€â”€ WcOfficeAccountServiceImpl.java    # å…¬ä¼—å·é…ç½®Serviceå®ç°
â”‚       â””â”€â”€ WcOfficePublishRecordServiceImpl.java # å‘å¸ƒè®°å½•Serviceå®ç°
```

#### 2. åŠ å¯†å­˜å‚¨å®ç°

**ä»£ç ä½ç½®ï¼š** `WcOfficeAccountServiceImpl.java` â†’ `saveOrUpdateWcOfficeAccount()`

```java
// åŠ å¯†appIdå’ŒappSecret
if (wcOfficeAccount.getAppId() != null && !wcOfficeAccount.getAppId().isEmpty()) {
    wcOfficeAccount.setAppId(AesEncryptUtils.encrypt(wcOfficeAccount.getAppId()));
}
if (wcOfficeAccount.getAppSecret() != null && !wcOfficeAccount.getAppSecret().isEmpty()) {
    wcOfficeAccount.setAppSecret(AesEncryptUtils.encrypt(wcOfficeAccount.getAppSecret()));
}
```

**åŠ å¯†å·¥å…·ä½ç½®ï¼š** `WxFbsir-common/src/main/java/com/wx/fbsir/common/utils/AesEncryptUtils.java`

---

### å¾®ä¿¡APIé›†æˆ

**ä»£ç ä½ç½®ï¼š** `WechatOfficialApiService.java`

#### å…³é”®æ–¹æ³•

```java
/**
 * è·å–access_token
 */
public String getAccessToken(WcOfficeAccount account) throws Exception {
    // è§£å¯†AppIDå’ŒAppSecret
    String appId = AesEncryptUtils.decrypt(account.getAppId());
    String appSecret = AesEncryptUtils.decrypt(account.getAppSecret());
    
    // è°ƒç”¨å¾®ä¿¡API
    String url = String.format(
        "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=%s&secret=%s",
        appId, appSecret
    );
    
    // è¿”å›access_token
    return jsonObject.getString("access_token");
}

/**
 * ä¸Šä¼ å›¾ç‰‡ç´ æ
 */
public Map<String, String> uploadImageMaterial(WcOfficeAccount account, String picUrl) 
    throws Exception {
    String accessToken = getAccessToken(account);
    return uploadImageMaterialInternal(accessToken, picUrl);
}

/**
 * æ·»åŠ æ–‡ç« åˆ°è‰ç¨¿ç®±
 */
public String addDraft(WcOfficeAccount account, String title, String author, 
                      String content, String thumbMediaId) throws Exception {
    String accessToken = getAccessToken(account);
    return addDraftInternal(accessToken, title, author, content, thumbMediaId);
}

/**
 * å®Œæ•´çš„å‘å¸ƒæµç¨‹
 */
public String publishToWechat(WcOfficeAccount account, String title, 
                             String content) throws Exception {
    // 1. ä¸Šä¼ å°é¢å›¾ç‰‡è·å–media_id
    // 2. æ·»åŠ æ–‡ç« åˆ°è‰ç¨¿ç®±
    // 3. è¿”å›è‰ç¨¿media_id
    String mediaId = addDraft(account, title, account.getAuthorName(), 
                             content, account.getMediaId());
    return mediaId;
}
```

---

#### å‘å¸ƒæµç¨‹

**ä»£ç ä½ç½®ï¼š** `WcOfficeAccountController.java` â†’ `publishToWechat()`

```java
@PostMapping("/publish")
public AjaxResult publishToWechat(@RequestBody Map<String, Object> body) {
    Long articleId = Long.valueOf(body.get("articleId").toString());
    String contentType = body.get("contentType").toString();
    
    // 1. éªŒè¯ç”¨æˆ·å…¬ä¼—å·é…ç½®
    WcOfficeAccount account = wcOfficeAccountService.getMyOfficeAccount();
    if (account == null || account.getIsActive() == 0) {
        return error("è¯·å…ˆé…ç½®å…¬ä¼—å·ä¿¡æ¯");
    }
    
    // 2. æŸ¥è¯¢æ–‡ç« å†…å®¹
    DailyArticle article = dailyArticleService.selectDailyArticleById(articleId);
    String content = getContentByType(article, contentType);
    
    // 3. åˆ›å»ºå‘å¸ƒè®°å½•
    WcOfficePublishRecord record = new WcOfficePublishRecord();
    record.setArticleId(articleId);
    record.setContentType(contentType);
    record.setPublishStatus(0); // å‘å¸ƒä¸­
    wcOfficePublishRecordService.insertWcOfficePublishRecord(record);
    
    try {
        // 4. è°ƒç”¨å¾®ä¿¡API
        String mediaId = wechatOfficialApiService.publishToWechat(
            account, article.getTitle(), content
        );
        
        // 5. æ›´æ–°å‘å¸ƒçŠ¶æ€å’Œæ–‡ç« å‘å¸ƒæ¬¡æ•°
        record.setPublishStatus(1); // æˆåŠŸ
        record.setMediaId(mediaId);
        wcOfficePublishRecordService.updateWcOfficePublishRecord(record);
        
        // æ›´æ–°æ–‡ç« å‘å¸ƒæ¬¡æ•°
        article.setPublishCount(article.getPublishCount() + 1);
        dailyArticleService.updateDailyArticle(article);
        
        return success("æŠ•é€’æˆåŠŸ");
    } catch (Exception e) {
        // æ›´æ–°å¤±è´¥çŠ¶æ€
        record.setPublishStatus(2); // å¤±è´¥
        record.setErrorMessage(e.getMessage());
        wcOfficePublishRecordService.updateWcOfficePublishRecord(record);
        return error("æŠ•é€’å¤±è´¥: " + e.getMessage());
    }
}
```

---

### è‰ç¨¿æŠ•é€’å‰ç«¯å®ç°

#### 1. å…¬ä¼—å·é…ç½®é¡µé¢

**ä»£ç ä½ç½®ï¼š** `WxFbsir-ui/src/views/system/user/profile/officeAccountConfig.vue`

**åŠŸèƒ½ï¼š**
- é…ç½®å…¬ä¼—å·å¼€å‘è€…IDå’Œå¯†é’¥
- ä¸Šä¼ ç´ æå°é¢å›¾
- å¯ç”¨/ç¦ç”¨å…¬ä¼—å·é…ç½®
- ä¸€é”®è·å–æœåŠ¡å™¨IP
- æ˜¾ç¤ºé…ç½®è¯´æ˜å’Œæ³¨æ„äº‹é¡¹

**é›†æˆä½ç½®ï¼š** å·²é›†æˆåˆ°ç”¨æˆ·ä¸ªäººèµ„æ–™é¡µé¢çš„"å…¬ä¼—å·é…ç½®"æ ‡ç­¾é¡µ

---

#### 2. æ—¥æ›´åŠ©æ‰‹é¡µé¢å¢å¼º

**ä»£ç ä½ç½®ï¼š** `WxFbsir-ui/src/views/business/content/dailyassistant/index.vue`

**æ–°å¢åŠŸèƒ½ï¼š**
- åœ¨æ¯ä¸ªå†…å®¹æ ‡ç­¾é¡µï¼ˆä¼˜åŒ–åå†…å®¹ã€æ¨¡å‹1ã€æ¨¡å‹2ã€æ¨¡å‹3ï¼‰æ·»åŠ "æŠ•é€’åˆ°å…¬ä¼—å·"æŒ‰é’®
- ç‚¹å‡»æŒ‰é’®å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
- æ˜¾ç¤ºæŠ•é€’è¿›åº¦å’Œç»“æœ
- è‡ªåŠ¨åˆ·æ–°æ–‡ç« åˆ—è¡¨æ›´æ–°å‘å¸ƒæ¬¡æ•°

**å…³é”®ä»£ç ï¼š**

```vue
<template>
  <el-button 
    type="success" 
    @click="handlePublishToWechat('optimized')"
    v-hasPermi="['business:daily:publish']"
  >
    æŠ•é€’åˆ°å…¬ä¼—å·
  </el-button>
</template>

<script setup>
const handlePublishToWechat = (contentType) => {
  proxy.$modal.confirm('ç¡®è®¤å°†æ­¤å†…å®¹æŠ•é€’åˆ°å…¬ä¼—å·è‰ç¨¿ç®±ï¼Ÿ').then(() => {
    const data = {
      articleId: currentArticle.value.id,
      contentType: contentType
    };
    
    return publishToWechat(data);
  }).then(() => {
    proxy.$modal.msgSuccess("æŠ•é€’æˆåŠŸ");
    getList(); // åˆ·æ–°åˆ—è¡¨
  }).catch(() => {});
};
</script>
```

---

#### 3. APIæ¥å£

**ä»£ç ä½ç½®ï¼š** `WxFbsir-ui/src/api/business/officeAccount.js`

**ä¸»è¦æ¥å£ï¼š**

```javascript
// è·å–å½“å‰ç”¨æˆ·é…ç½®
export function getMyOfficeAccount() {
  return request({
    url: '/business/office-account/my',
    method: 'get'
  })
}

// æ–°å¢/æ›´æ–°é…ç½®
export function addOfficeAccount(data) {
  return request({
    url: '/business/office-account',
    method: 'post',
    data: data
  })
}

// å‘å¸ƒæ–‡ç« åˆ°å…¬ä¼—å·
export function publishToWechat(data) {
  return request({
    url: '/business/office-account/publish',
    method: 'post',
    data: data
  })
}

// æŸ¥è¯¢å‘å¸ƒè®°å½•
export function getPublishRecords(articleId) {
  return request({
    url: '/business/office-publish-record/list',
    method: 'get',
    params: { articleId }
  })
}

// è·å–æœåŠ¡å™¨IP
export function getServerIp() {
  return request({
    url: '/business/office-account/server-ip',
    method: 'get'
  })
}
```

---

## ğŸ“ ä»£ç æ–‡ä»¶ç»“æ„

### åç«¯ä»£ç 

#### ä¸šåŠ¡æ¨¡å—

**ä½ç½®ï¼š** `WxFbsir-business/src/main/java/com/wx/fbsir/business/officialaccount/`

```
officialaccount/
â”œâ”€â”€ controller/
â”‚   â””â”€â”€ WcOfficeAccountController.java         # å…¬ä¼—å·é…ç½®å’Œå‘å¸ƒæ§åˆ¶å™¨
â”‚       â”œâ”€â”€ getMyOfficeAccount()              # è·å–é…ç½®
â”‚       â”œâ”€â”€ addOfficeAccount()                # ä¿å­˜é…ç½®
â”‚       â”œâ”€â”€ publishToWechat()                 # å‘å¸ƒæ–‡ç« 
â”‚       â””â”€â”€ getServerIp()                     # è·å–æœåŠ¡å™¨IP
â”‚
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ WcOfficeAccount.java                   # å…¬ä¼—å·é…ç½®å®ä½“
â”‚   â””â”€â”€ WcOfficePublishRecord.java             # å‘å¸ƒè®°å½•å®ä½“
â”‚
â”œâ”€â”€ mapper/
â”‚   â”œâ”€â”€ WcOfficeAccountMapper.java             # é…ç½®Mapperæ¥å£
â”‚   â””â”€â”€ WcOfficePublishRecordMapper.java       # è®°å½•Mapperæ¥å£
â”‚
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ IWcOfficeAccountService.java           # é…ç½®Serviceæ¥å£
â”‚   â”œâ”€â”€ IWcOfficePublishRecordService.java     # è®°å½•Serviceæ¥å£
â”‚   â”œâ”€â”€ WechatOfficialApiService.java          # å¾®ä¿¡APIæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ getAccessToken()                  # è·å–access_token
â”‚   â”‚   â”œâ”€â”€ uploadImageMaterial()             # ä¸Šä¼ å›¾ç‰‡ç´ æ
â”‚   â”‚   â”œâ”€â”€ addDraft()                        # æ·»åŠ è‰ç¨¿
â”‚   â”‚   â””â”€â”€ publishToWechat()                 # å®Œæ•´å‘å¸ƒæµç¨‹
â”‚   â”‚
â”‚   â””â”€â”€ impl/
â”‚       â”œâ”€â”€ WcOfficeAccountServiceImpl.java    # é…ç½®Serviceå®ç°
â”‚       â”‚   â”œâ”€â”€ saveOrUpdateWcOfficeAccount()  # ä¿å­˜é…ç½®ï¼ˆå«åŠ å¯†ï¼‰
â”‚       â”‚   â”œâ”€â”€ getMyOfficeAccount()           # è·å–é…ç½®ï¼ˆå«è§£å¯†ï¼‰
â”‚       â”‚   â””â”€â”€ validateAccount()              # éªŒè¯é…ç½®
â”‚       â”‚
â”‚       â””â”€â”€ WcOfficePublishRecordServiceImpl.java # è®°å½•Serviceå®ç°
```

#### Mapper XML

**ä½ç½®ï¼š** `WxFbsir-business/src/main/resources/mapper/officialaccount/`

```
mapper/officialaccount/
â”œâ”€â”€ WcOfficeAccountMapper.xml              # é…ç½®è¡¨æ˜ å°„
â””â”€â”€ WcOfficePublishRecordMapper.xml        # è®°å½•è¡¨æ˜ å°„
```

#### å·¥å…·ç±»

**ä½ç½®ï¼š** `WxFbsir-common/src/main/java/com/wx/fbsir/common/utils/`

```
utils/
â”œâ”€â”€ AesEncryptUtils.java                   # AESåŠ å¯†å·¥å…·
â”‚   â”œâ”€â”€ encrypt()                         # åŠ å¯†æ–¹æ³•
â”‚   â””â”€â”€ decrypt()                         # è§£å¯†æ–¹æ³•
â”‚
â”œâ”€â”€ file/
â”‚   â””â”€â”€ FileUploadUtils.java              # æ–‡ä»¶ä¸Šä¼ å·¥å…·
â”‚       â”œâ”€â”€ officialAccountFilename()      # ç”Ÿæˆæ–‡ä»¶å
â”‚       â””â”€â”€ uploadOfficialAccountAndGetFullUrl() # ä¸Šä¼ å¹¶è¿”å›URL
â”‚
â””â”€â”€ IpUtils.java                          # IPå·¥å…·ï¼ˆç”¨äºè·å–æœåŠ¡å™¨IPï¼‰
```

#### é€šç”¨æ§åˆ¶å™¨

**ä½ç½®ï¼š** `WxFbsir-admin/src/main/java/com/wx/fbsir/web/controller/common/`

```
common/
â””â”€â”€ CommonController.java                 # é€šç”¨æ§åˆ¶å™¨
    â””â”€â”€ uploadOfficialAccountImage()      # å…¬ä¼—å·å›¾ç‰‡ä¸Šä¼ æ¥å£
```

---

### å‰ç«¯ä»£ç 

**ä½ç½®ï¼š** `WxFbsir-ui/src/`

```
src/
â”œâ”€â”€ api/business/
â”‚   â””â”€â”€ officeAccount.js                  # å…¬ä¼—å·API
â”‚       â”œâ”€â”€ getMyOfficeAccount()          # è·å–é…ç½®
â”‚       â”œâ”€â”€ addOfficeAccount()            # ä¿å­˜é…ç½®
â”‚       â”œâ”€â”€ publishToWechat()             # å‘å¸ƒæ–‡ç« 
â”‚       â””â”€â”€ getServerIp()                 # è·å–æœåŠ¡å™¨IP
â”‚
â”œâ”€â”€ views/
â”‚   â”œâ”€â”€ system/user/profile/
â”‚   â”‚   â”œâ”€â”€ index.vue                     # ç”¨æˆ·èµ„æ–™ä¸»é¡µï¼ˆå·²ä¿®æ”¹ï¼‰
â”‚   â”‚   â””â”€â”€ officeAccountConfig.vue       # å…¬ä¼—å·é…ç½®ç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ é…ç½®è¡¨å•                  # AppIDã€AppSecretè¾“å…¥
â”‚   â”‚       â”œâ”€â”€ å›¾ç‰‡ä¸Šä¼                   # ç´ æå°é¢å›¾ä¸Šä¼ 
â”‚   â”‚       â””â”€â”€ IPè·å–                    # ä¸€é”®è·å–æœåŠ¡å™¨IP
â”‚   â”‚
â”‚   â””â”€â”€ business/content/
â”‚       â””â”€â”€ dailyassistant/
â”‚           â””â”€â”€ index.vue                 # æ—¥æ›´åŠ©æ‰‹ï¼ˆå·²ä¿®æ”¹ï¼‰
â”‚               â”œâ”€â”€ æ–‡ç« åˆ—è¡¨              # æ˜¾ç¤ºå‘å¸ƒæ¬¡æ•°
â”‚               â””â”€â”€ å†…å®¹æ ‡ç­¾é¡µ            # æ·»åŠ æŠ•é€’æŒ‰é’®
â”‚
â””â”€â”€ components/
    â””â”€â”€ ImageUpload/                      # å›¾ç‰‡ä¸Šä¼ ç»„ä»¶ï¼ˆé€šç”¨ï¼‰
        â””â”€â”€ index.vue
```

---

### é…ç½®æ–‡ä»¶

```
WxFbsir-admin/src/main/resources/
â””â”€â”€ application.yml                       # åº”ç”¨é…ç½®
    â””â”€â”€ aes.secret.key                    # AESå¯†é’¥é…ç½®
```

---

### æ•°æ®åº“è„šæœ¬

```
sql/updates/
â””â”€â”€ update_20251208_wc_office_account.sql # æ•°æ®åº“æ›´æ–°è„šæœ¬
    â”œâ”€â”€ wc_office_account è¡¨              # å…¬ä¼—å·é…ç½®è¡¨
    â””â”€â”€ wc_office_publish_record è¡¨       # å‘å¸ƒè®°å½•è¡¨
```

---

## ğŸ”’ å®‰å…¨æ€§è€ƒè™‘

### 1. è·¯å¾„å®‰å…¨

- âœ… ç”¨æˆ·IDä»ç™»å½•ä¿¡æ¯è·å–ï¼Œæ— æ³•ä¼ªé€ 
- âœ… ä¸æ¥å—å‰ç«¯ä¼ é€’çš„ç”¨æˆ·ID
- âœ… è‡ªåŠ¨åˆ›å»ºç”¨æˆ·ç›®å½•ï¼Œé¿å…è·¯å¾„éå†

**ä»£ç ä½ç½®ï¼š** `CommonController.java` â†’ `uploadOfficialAccountImage()`

---

### 2. æ–‡ä»¶éªŒè¯

- âœ… ä¸¥æ ¼é™åˆ¶æ–‡ä»¶ç±»å‹ï¼ˆä»…å›¾ç‰‡ï¼‰
- âœ… é™åˆ¶æ–‡ä»¶å¤§å°ï¼ˆ5MBï¼‰
- âœ… éªŒè¯æ–‡ä»¶åé•¿åº¦ï¼ˆ100å­—ç¬¦ï¼‰

**ä»£ç ä½ç½®ï¼š** `FileUploadUtils.java` â†’ `assertAllowed()`

---

### 3. æƒé™æ§åˆ¶

- âœ… éœ€è¦ç™»å½•æ‰èƒ½ä¸Šä¼ 
- âœ… åªèƒ½è®¿é—®è‡ªå·±çš„æ–‡ä»¶
- âœ… ä½¿ç”¨ `@PreAuthorize` æ§åˆ¶æ¥å£è®¿é—®

**æƒé™æ ‡è¯†ï¼š**
- é…ç½®ç®¡ç†ï¼š`business:office:config`
- æ–‡ç« å‘å¸ƒï¼š`business:daily:publish`

---

### 4. æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

- âœ… AppIDå’ŒAppSecretä½¿ç”¨AES-256-GCMåŠ å¯†å­˜å‚¨
- âœ… å‰ç«¯è¿”å›é…ç½®æ—¶ä¸åŒ…å«æ˜æ–‡å¯†é’¥
- âœ… æ¯æ¬¡åŠ å¯†ä½¿ç”¨éšæœºIV
- âœ… æä¾›è®¤è¯æ ‡ç­¾é˜²æ­¢ç¯¡æ”¹

**ä»£ç ä½ç½®ï¼š** `AesEncryptUtils.java`

---

**æœ€åæ›´æ–°ï¼š** 2025-12-09
