# 积分系统使用指南

本文档说明如何在业务代码中使用积分系统进行积分扣减和发放。

---

## 📋 目录

- [快速开始](#快速开始)
- [积分前置校验服务](#积分前置校验服务)
- [使用示例](#使用示例)
- [错误码说明](#错误码说明)
- [注意事项](#注意事项)

---

## 快速开始

### 1. 依赖注入

在需要使用积分功能的 Controller 或 Service 中注入 `PointsPrecheckService`：

```java
@Autowired
private PointsPrecheckService pointsPrecheckService;
```

### 2. 基本使用

在业务逻辑执行前，调用积分前置校验服务：

```java
PointsResult result = pointsPrecheckService.tryChangePoints(userId, "USE_DAILY_ASSISTANT", null);
if (!result.isSuccess()) {
    return AjaxResult.error(result.getMsg()); // 直接拦截，不执行后续业务
}
// 积分校验通过，继续执行业务逻辑
```

---

## 积分前置校验服务

### PointsPrecheckService

**核心方法**：`tryChangePoints(Long userId, String ruleCode, Integer changeAmount)`

**参数说明**：
- `userId`：用户ID（必填）
- `ruleCode`：规则编码（必填），使用枚举 `PointsRuleCode` 中的编码
- `changeAmount`：积分变动值（可选），不传则使用规则默认值

**返回值**：`PointsResult`
- `isSuccess()`：是否成功
- `getCode()`：错误码（失败时）
- `getMsg()`：错误消息（失败时）
- `getDelta()`：积分变动值（成功时）
- `getBalanceAfter()`：变动后余额（成功时）

---

## 使用示例

### 示例1：日更助手文章生成（扣减积分）

```java
@PostMapping("/createAndOptimize")
public AjaxResult createAndOptimize(@RequestBody Map<String, String> params) {
    Long userId = getUserId();
    
    // 积分前置校验：使用日更助手规则编码
    PointsResult pointsResult = pointsPrecheckService.tryChangePoints(
        userId, 
        PointsRuleCode.USE_DAILY_ASSISTANT.getCode(), 
        null
    );
    
    if (!pointsResult.isSuccess()) {
        // 积分不足或规则校验失败，直接拦截
        return AjaxResult.error(pointsResult.getMsg());
    }
    
    // 积分校验通过，继续执行业务
    DailyArticle article = dailyArticleService.createArticleAndOptimize(
        userId, 
        articleTitle, 
        selectedModels
    );
    
    // 返回结果，包含扣减后的积分余额
    Map<String, Object> result = new HashMap<>();
    result.put("id", article.getId());
    result.put("pointsBalance", pointsResult.getBalanceAfter());
    
    return AjaxResult.success(result);
}
```

### 示例2：每日登录奖励（增加积分）

```java
@PostMapping("/dailyLogin")
public AjaxResult dailyLogin() {
    Long userId = getUserId();
    
    // 积分前置校验：使用每日登录规则编码
    PointsResult pointsResult = pointsPrecheckService.tryChangePoints(
        userId, 
        PointsRuleCode.DAILY_LOGIN.getCode(), 
        null
    );
    
    if (!pointsResult.isSuccess()) {
        return AjaxResult.error(pointsResult.getMsg());
    }
    
    // 登录奖励发放成功
    return AjaxResult.success("登录奖励已发放，获得 " + pointsResult.getDelta() + " 积分");
}
```

### 示例3：自定义积分值

```java
// 如果需要在规则默认值基础上自定义积分值
PointsResult pointsResult = pointsPrecheckService.tryChangePoints(
    userId, 
    "USE_DAILY_ASSISTANT", 
    -5  // 自定义扣减5积分
);
```

---

## 错误码说明

| 错误码 | 说明 | 处理建议 |
|--------|------|---------|
| `USER_EMPTY` | 用户ID为空 | 检查用户登录状态 |
| `USER_NOT_FOUND` | 用户不存在 | 检查用户ID是否正确 |
| `USER_DISABLED` | 用户不可用 | 联系管理员启用用户 |
| `RULE_EMPTY` | 规则编码为空 | 检查规则编码参数 |
| `RULE_NOT_FOUND` | 积分规则不存在 | 检查规则编码是否正确，或联系管理员配置规则 |
| `RULE_DISABLED` | 积分规则已停用 | 联系管理员启用规则 |
| `POINTS_ZERO` | 积分变动值无效 | 检查规则配置 |
| `LIMIT_REACHED` | 已达到限频上限 | 提示用户稍后再试 |
| `MAX_AMOUNT_REACHED` | 已达到累计上限 | 提示用户已达到上限 |
| `INSUFFICIENT_BALANCE` | 积分余额不足 | 提示用户充值或获取积分 |
| `POINTS_ERROR` | 积分处理失败 | 记录日志，联系技术支持 |

---

## 注意事项

### 1. 规则编码使用

- ✅ **正确**：使用枚举 `PointsRuleCode.USE_DAILY_ASSISTANT.getCode()`
- ✅ **正确**：直接使用字符串 `"USE_DAILY_ASSISTANT"`
- ❌ **错误**：使用规则名称 `"使用日更助手"`

### 2. 业务执行顺序

**必须**在业务逻辑执行前进行积分校验：

```java
// ✅ 正确：先校验积分，再执行业务
PointsResult result = pointsPrecheckService.tryChangePoints(userId, ruleCode, null);
if (!result.isSuccess()) {
    return AjaxResult.error(result.getMsg());
}
// 执行业务逻辑
doBusiness();

// ❌ 错误：先执行业务，再校验积分
doBusiness();
PointsResult result = pointsPrecheckService.tryChangePoints(userId, ruleCode, null);
```

### 3. 事务处理

积分前置校验服务内部已包含事务处理，无需在业务层再次添加事务注解。

### 4. 异常处理

积分前置校验服务已统一封装所有异常情况，业务方只需检查 `isSuccess()` 即可。

---

## 常见规则编码

| 规则编码 | 说明 | 积分值 |
|---------|------|--------|
| `USE_DAILY_ASSISTANT` | 使用日更助手 | -1 |
| `DAILY_LOGIN` | 每日登录 | +10 |
| `TEMPLATE_PUBLISH` | 模板上架 | +50 |
| `TEMPLATE_BUY` | 模板购买 | -10 |
| `TEMPLATE_REWARD` | 模板分成 | +8 |
| `RECHARGE` | 充值赠送 | +100 |

---

## 权限管理

### 功能菜单权限

积分系统包含以下功能菜单及其权限配置：

| 菜单名称 | 菜单ID | 权限标识 | 说明 |
|---------|-------|---------|------|
| 积分管理 | 6 | - | 一级菜单 |
| 积分总览 | 120 | business:points:view | 积分总览页面 |
| 积分规则配置 | 121 | points:rule:list | 积分规则配置页面 |
| 粉丝管理 | 122 | points:fans:list | 粉丝管理页面 |

### 按钮权限

| 按钮名称 | 按钮ID | 所属菜单 | 权限标识 | 说明 |
|---------|-------|---------|---------|------|
| 积分查询 | 1070 | 积分总览 | business:points:query | 查询用户积分余额 |
| 明细查询 | 1071 | 积分总览 | business:points:record:query | 查询积分变动明细 |
| 规则查询 | 1072 | 积分规则配置 | points:rule:query | 查询积分规则 |
| 规则新增 | 1073 | 积分规则配置 | points:rule:add | 新增积分规则 |
| 规则修改 | 1074 | 积分规则配置 | points:rule:edit | 修改积分规则 |
| 规则删除 | 1075 | 积分规则配置 | points:rule:remove | 删除积分规则 |
| 粉丝列表 | 1076 | 粉丝管理 | points:fans:list | 查看粉丝列表 |
| 发放积分 | 1077 | 粉丝管理 | points:fans:grant | 给用户发放积分 |
| 查看明细 | 1078 | 粉丝管理 | points:fans:detail | 查看用户积分明细 |

### 角色权限分配

| 角色ID | 角色权限说明 |
|-------|------------|
| 2 | 拥有积分管理的全部权限（包括菜单和所有按钮权限，新增粉丝管理的全部权限） |
| 3 | 拥有积分管理菜单的只读访问权限 |
| 10 | 普通用户角色，拥有积分查询、明细查询、规则查询、粉丝列表和查看明细权限 |

---

**最后更新**: 2025-12-10  
**文档版本**: v1.0.1

