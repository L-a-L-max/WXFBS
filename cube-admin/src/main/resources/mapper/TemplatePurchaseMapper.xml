<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cube.wechat.selfapp.app.mapper.TemplatePurchaseMapper">

    <resultMap type="com.cube.wechat.selfapp.app.domain.TemplatePurchase" id="TemplatePurchaseResult">
        <result property="id" column="id"/>
        <result property="templateType" column="template_type"/>
        <result property="templateId" column="template_id"/>
        <result property="templateName" column="template_name"/>
        <result property="userId" column="user_id"/>
        <result property="authorId" column="author_id"/>
        <result property="purchasePrice" column="purchase_price"/>
        <result property="authorIncome" column="author_income"/>
        <result property="platformFee" column="platform_fee"/>
        <result property="purchaseTime" column="purchase_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="status" column="status"/>
        <result property="remark" column="remark"/>
    </resultMap>

    <insert id="insertTemplatePurchase" parameterType="com.cube.wechat.selfapp.app.domain.TemplatePurchase">
        insert into wc_template_purchase (template_type, template_id, template_name, user_id, author_id, purchase_price, author_income, platform_fee, purchase_time, status, remark)
        values (#{templateType}, #{templateId}, #{templateName}, #{userId}, #{authorId}, #{purchasePrice}, #{authorIncome}, #{platformFee}, NOW(), #{status}, #{remark})
    </insert>

    <select id="selectByTemplateIdAndUserId" resultMap="TemplatePurchaseResult">
        select * from wc_template_purchase
        where template_type = #{templateType} and template_id = #{templateId} and user_id = #{userId} and status = 1
        limit 1
    </select>

    <!-- 查询用户购买的模板列表（根据模板类型区分） -->
    <select id="selectPurchasedTemplatesByUserId" resultType="java.util.HashMap">
        <choose>
            <!-- 模板类型1：提示词模板(CallWord) -->
            <when test="templateType == 1">
                select 
                    tp.id,
                    tp.template_type as templateType,
                    tp.template_id as templateId,
                    tp.purchase_price as purchasePrice,
                    tp.purchase_time as purchaseTime,
                    cw.platform_id as name,
                    cw.word_content as prompt,
                    cw.price,
                    u.user_name as authorName
                from wc_template_purchase tp
                inner join wc_call_word cw on tp.template_id = cw.platform_id COLLATE utf8mb4_unicode_ci
                left join sys_user u on cw.user_id = u.user_id COLLATE utf8mb4_unicode_ci
                <where>
                    tp.template_type = #{templateType}
                    and tp.user_id = #{userId}
                    and tp.status = 1
                    <if test="name != null and name != ''"> 
                        and cw.platform_id like concat('%', #{name}, '%')
                    </if>
                </where>
                order by tp.purchase_time desc
                limit #{offset}, #{limit}
            </when>
            <!-- 模板类型2：评分模板(PromptTemplate) -->
            <otherwise>
                select 
                    tp.id,
                    tp.template_type as templateType,
                    tp.template_id as templateId,
                    tp.purchase_price as purchasePrice,
                    tp.purchase_time as purchaseTime,
                    pt.name,
                    pt.prompt,
                    pt.price,
                    u.user_name as authorName
                from wc_template_purchase tp
                inner join wc_prompt_template pt on CAST(tp.template_id AS UNSIGNED) = pt.id and pt.type = 3
                left join sys_user u on pt.user_id = u.user_id COLLATE utf8mb4_unicode_ci
                <where>
                    tp.template_type = #{templateType}
                    and tp.user_id = #{userId}
                    and tp.status = 1
                    and pt.isdel = 0
                    <if test="name != null and name != ''"> 
                        and pt.name like concat('%', #{name}, '%')
                    </if>
                </where>
                order by tp.purchase_time desc
                limit #{offset}, #{limit}
            </otherwise>
        </choose>
    </select>

    <!-- 统计用户购买的模板数量（根据模板类型区分） -->
    <select id="countPurchasedTemplatesByUserId" resultType="int">
        <choose>
            <!-- 模板类型1：提示词模板(CallWord) -->
            <when test="templateType == 1">
                select count(1)
                from wc_template_purchase tp
                inner join wc_call_word cw on tp.template_id = cw.platform_id COLLATE utf8mb4_unicode_ci
                <where>
                    tp.template_type = #{templateType}
                    and tp.user_id = #{userId}
                    and tp.status = 1
                    <if test="name != null and name != ''"> 
                        and cw.platform_id like concat('%', #{name}, '%')
                    </if>
                </where>
            </when>
            <!-- 模板类型2：评分模板(PromptTemplate) -->
            <otherwise>
                select count(1)
                from wc_template_purchase tp
                inner join wc_prompt_template pt on CAST(tp.template_id AS UNSIGNED) = pt.id and pt.type = 3
                <where>
                    tp.template_type = #{templateType}
                    and tp.user_id = #{userId}
                    and tp.status = 1
                    and pt.isdel = 0
                    <if test="name != null and name != ''"> 
                        and pt.name like concat('%', #{name}, '%')
                    </if>
                </where>
            </otherwise>
        </choose>
    </select>

</mapper>

